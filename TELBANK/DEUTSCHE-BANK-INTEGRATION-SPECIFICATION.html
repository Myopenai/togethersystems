<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>DEUTSCHE-BANK-INTEGRATION-SPECIFICATION</title>
<style>
body { font-family: system-ui; max-width: 800px; margin: 0 auto; padding: 20px; }
pre { background: #f5f5f5; padding: 10px; border-radius: 5px; overflow-x: auto; }
code { background: #f5f5f5; padding: 2px 4px; border-radius: 3px; }
</style>
</head>
<body>
<h1>Deutsche Bank Integration ‚Äì Vollst√§ndige Spezifikation</h1>

<strong>LOGO:</strong> `T,.&T,,.&T,,,.(C)TEL1.NL`  
<strong>VERSION:</strong> 1.0.0-XXXL-DB-INTEGRATION  
<strong>STANDARD:</strong> IBM Industrial Fabrication Software Machine  
<strong>DATUM:</strong> 2025-01-15  
<strong>STATUS:</strong> Prototyp-Bereit f√ºr Deutsche Bank Partnerschaft  

---

<h2>üè¶ √úBERSICHT</h2>

<h3>Zielsetzung</h3>
Integration der <strong>Deutsche Bank AG</strong> als <strong>Hauptbank-Partner</strong> f√ºr Together Systems, speziell f√ºr:
- TPGA Telbank ‚Üí Deutsche Bank Geldfluss
- Crypto ‚Üî Fiat Umtausch (via regulierte Exchanges)
- Negative Assets Management
- Compliance & Reporting (BaFin)
- KYC/AML-Prozesse
- API-basierte Transaktionen

<h3>Strategische Position</h3>
- <strong>Deutsche Bank</strong> = Hauptbank-Partner (seit 40+ Jahren Kundenbeziehung des Initiators)
- <strong>Peladia Bank</strong> = Zweitbank (Tokai-do-System)
- <strong>TELBANK</strong> = Erste Bank (zeitverifiziert)
- <strong>MetaMask</strong> = Einzige Wallet f√ºr Wechselkursaktionen

---

<h2>üì° API-INTEGRATION</h2>

<h3>1. Deutsche Bank API Overview</h3>

<h4>1.1 Verf√ºgbare APIs</h4>

<strong>Deutsche Bank API Portal:</strong>
- <strong>Sandbox:</strong> `https://api-sandbox.db.com`
- <strong>Production:</strong> `https://api.db.com`
- <strong>Documentation:</strong> `https://developer.db.com`

<h4>1.2 API-Kategorien</h4>

##### A. Account Information Services (AIS)
```json
{
  "base_url": "https://api.db.com/v2/ais",
  "endpoints": {
    "accounts": "/accounts",
    "balances": "/accounts/{accountId}/balances",
    "transactions": "/accounts/{accountId}/transactions",
    "account_details": "/accounts/{accountId}"
  },
  "authentication": "OAuth 2.0 / PSD2",
  "scopes": ["ais:accounts:read", "ais:transactions:read"]
}
```

##### B. Payment Initiation Services (PIS)
```json
{
  "base_url": "https://api.db.com/v2/pis",
  "endpoints": {
    "payment_initiation": "/payments",
    "payment_status": "/payments/{paymentId}/status",
    "payment_cancellation": "/payments/{paymentId}/cancellation",
    "bulk_payments": "/bulk-payments"
  },
  "authentication": "OAuth 2.0 / PSD2",
  "scopes": ["pis:payments:create"]
}
```

##### C. Corporate Banking API
```json
{
  "base_url": "https://api.db.com/v1/corporate",
  "endpoints": {
    "cash_management": "/cash-management",
    "trade_finance": "/trade-finance",
    "foreign_exchange": "/fx",
    "liquidity": "/liquidity"
  },
  "authentication": "Certificate-based (mTLS)",
  "certificate_required": true
}
```

##### D. Trade Finance API
```json
{
  "base_url": "https://api.db.com/v1/trade",
  "endpoints": {
    "letters_of_credit": "/letters-of-credit",
    "guarantees": "/guarantees",
    "export_financing": "/export-financing"
  },
  "authentication": "Certificate-based (mTLS)"
}
```

---

<h2>üîê AUTHENTICATION & ZERTIFIKATE</h2>

<h3>2. Certificate Management</h3>

<h4>2.1 Zertifikats-Anforderungen</h4>

<strong>F√ºr Corporate Banking API (mTLS):</strong>
```yaml
certificate_type: "X.509 Client Certificate"
format: "PEM oder PKCS#12"
key_size: "RSA 2048 bit minimum (RSA 4096 empfohlen)"
validity_period: "1-3 Jahre"
issuer: "Deutsche Bank Certificate Authority oder akkreditierte CA"
subject_dn: "CN={Company Name}, O={Organization}, C={Country}"
key_usage: "Digital Signature, Key Encipherment"
extended_key_usage: "Client Authentication"
```

<h4>2.2 Zertifikats-Erstellung (Prototyp-Phase)</h4>

<strong>Schritt 1: Certificate Signing Request (CSR) generieren</strong>
```bash
<h1>RSA 4096 bit private key generieren</h1>
openssl genrsa -out db-client-key.pem 4096

<h1>CSR generieren</h1>
openssl req -new -key db-client-key.pem -out db-client.csr \
  -subj "/CN=Together Systems/O=TEL1.NL/C=NL"
```

<strong>Schritt 2: CSR an Deutsche Bank senden</strong>
- Via Partner Portal oder direkter Kontakt zu Corporate Banking
- Deutsche Bank stellt signiertes Zertifikat aus

<strong>Schritt 3: Zertifikat in System integrieren</strong>
```javascript
// Certificate Storage (sicher)
const certificateConfig = {
  clientCert: fs.readFileSync('db-client-cert.pem'),
  clientKey: fs.readFileSync('db-client-key.pem'),
  caCert: fs.readFileSync('db-ca-cert.pem'), // Deutsche Bank CA
  passphrase: process.env.CERT_PASSPHRASE // Aus sicherer Quelle
};
```

<h4>2.3 OAuth 2.0 f√ºr PSD2 APIs (AIS/PIS)</h4>

```json
{
  "grant_type": "authorization_code",
  "client_id": "DEUTSCHE_BANK_CLIENT_ID",
  "client_secret": "DEUTSCHE_BANK_CLIENT_SECRET",
  "redirect_uri": "https://togethersystems.com/auth/callback",
  "scope": "ais:accounts:read pis:payments:create",
  "authorization_endpoint": "https://api.db.com/oauth/authorize",
  "token_endpoint": "https://api.db.com/oauth/token"
}
```

---

<h2>üíº COMPLIANCE & REGULATORIK</h2>

<h3>3. BaFin-Anforderungen</h3>

<h4>3.1 PSD2-Compliance</h4>

<strong>Payment Services Directive 2 (PSD2):</strong>
- ‚úÖ Strong Customer Authentication (SCA)
- ‚úÖ Regulatory Technical Standards (RTS)
- ‚úÖ Third-Party Provider (TPP) Registrierung
- ‚úÖ API-Zugang f√ºr AIS/PIS

<strong>Deutsche Bank PSD2 API:</strong>
- EIDAS-konformes Zertifikat erforderlich
- TPP-Identifikation via QWAC/QSEAL
- SCA via Redirect oder Embedded Flow

<h4>3.2 KYC/AML-Prozesse</h4>

<strong>Know Your Customer (KYC):</strong>
```json
{
  "kyc_level": "Enhanced Due Diligence",
  "requirements": [
    "Firmenidentit√§t (Handelsregister)",
    "Gesch√§ftsf√ºhrer-Identit√§t (Ausweis)",
    "Gesch√§ftst√§tigkeit-Beschreibung",
    "Erwartete Transaktionsvolumen",
    "Herkunft der Mittel (Source of Funds)",
    "Zweck der Gesch√§ftsbeziehung"
  ],
  "ongoing_monitoring": true,
  "review_frequency": "J√§hrlich oder bei √Ñnderungen"
}
```

<strong>Anti-Money Laundering (AML):</strong>
- ‚úÖ Transaktions-Monitoring (suspicious activity reporting)
- ‚úÖ Sanctions Screening (UN/EU/US Sanctions Lists)
- ‚úÖ PEP-Screening (Politically Exposed Persons)
- ‚úÖ Risk Assessment (low/medium/high risk customer)

<h4>3.3 Reporting-Anforderungen</h4>

<strong>BaFin-Meldepflichten:</strong>
- Gro√übetragsanzeigen (> ‚Ç¨15.000)
- Verdachtsanzeigen (suspicious transactions)
- J√§hrliche Risikobewertung

<strong>Deutsche Bank Reporting:</strong>
- Automatisches Reporting via API m√∂glich
- CSV/XML-Export f√ºr manuelle Meldungen

---

<h2>üîÑ INTEGRATION-ARCHITEKTUR</h2>

<h3>4. System-Integration</h3>

<h4>4.1 TELBANK ‚Üí Deutsche Bank Flow</h4>

```mermaid
graph LR
    A[User MetaMask Wallet] -->|Crypto Transfer| B[TELBANK System]
    B -->|Fiat Conversion| C[Regulated Exchange]
    C -->|SEPA Transfer| D[Deutsche Bank API]
    D -->|Account Credit| E[DB Corporate Account]
    E -->|Real Economy| F[Payment/Investment]
```

<h4>4.2 API-Integration Layer</h4>

<strong>Cloudflare Workers Function:</strong>
```javascript
// functions/api/deutsche-bank/client.js
export class DeutscheBankClient {
  constructor(config) {
    this.baseUrl = config.environment === 'production' 
      ? 'https://api.db.com' 
      : 'https://api-sandbox.db.com';
    this.certificate = config.certificate;
    this.clientId = config.clientId;
    this.clientSecret = config.clientSecret;
  }

  async initiatePayment(paymentData) {
    // mTLS f√ºr Corporate Banking API
    const response = await fetch(`${this.baseUrl}/v1/corporate/payments`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Request-ID': crypto.randomUUID()
      },
      body: JSON.stringify(paymentData),
      // Certificate-based authentication
      cf: {
        clientTlsAuth: {
          cert: this.certificate.clientCert,
          key: this.certificate.clientKey
        }
      }
    });
    return response.json();
  }

  async getAccountBalance(accountId) {
    // OAuth 2.0 f√ºr PSD2 AIS API
    const token = await this.getOAuthToken();
    const response = await fetch(
      `${this.baseUrl}/v2/ais/accounts/${accountId}/balances`,
      {
        headers: {
          'Authorization': `Bearer ${token}`,
          'X-Request-ID': crypto.randomUUID()
        }
      }
    );
    return response.json();
  }

  async getOAuthToken() {
    // OAuth 2.0 token refresh logic
    // ...
  }
}
```

<h4>4.3 D1 Database Schema f√ºr Deutsche Bank Integration</h4>

```sql
-- Deutsche Bank Accounts
CREATE TABLE IF NOT EXISTS deutsche_bank_account (
  account_id TEXT PRIMARY KEY,
  iban TEXT UNIQUE NOT NULL,
  bic TEXT,
  account_name TEXT,
  account_type TEXT CHECK (account_type IN ('current', 'savings', 'corporate')),
  currency TEXT(3) NOT NULL DEFAULT 'EUR',
  status TEXT CHECK (status IN ('active', 'suspended', 'closed')),
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  updated_at TEXT NOT NULL DEFAULT (datetime('now'))
);

-- Deutsche Bank Transactions
CREATE TABLE IF NOT EXISTS deutsche_bank_transaction (
  transaction_id TEXT PRIMARY KEY,
  account_id TEXT NOT NULL REFERENCES deutsche_bank_account(account_id),
  external_ref TEXT, -- Deutsche Bank Transaction ID
  amount REAL NOT NULL,
  currency TEXT(3) NOT NULL,
  direction TEXT CHECK (direction IN ('credit', 'debit')),
  counterparty_iban TEXT,
  counterparty_name TEXT,
  payment_reference TEXT,
  transaction_date TEXT NOT NULL,
  value_date TEXT,
  status TEXT CHECK (status IN ('pending', 'completed', 'failed', 'cancelled')),
  metadata_json TEXT, -- JSON f√ºr zus√§tzliche Daten
  created_at TEXT NOT NULL DEFAULT (datetime('now'))
);

-- Deutsche Bank API Logs (Audit)
CREATE TABLE IF NOT EXISTS deutsche_bank_api_log (
  log_id TEXT PRIMARY KEY,
  endpoint TEXT NOT NULL,
  method TEXT NOT NULL,
  request_id TEXT,
  status_code INTEGER,
  request_body TEXT,
  response_body TEXT,
  error_message TEXT,
  timestamp TEXT NOT NULL DEFAULT (datetime('now'))
);

-- Indexes
CREATE INDEX idx_db_transaction_account ON deutsche_bank_transaction(account_id);
CREATE INDEX idx_db_transaction_date ON deutsche_bank_transaction(transaction_date);
CREATE INDEX idx_db_api_log_timestamp ON deutsche_bank_api_log(timestamp);
```

---

<h2>üí∞ GELDFLUSS-INTEGRATION</h2>

<h3>5. Crypto ‚Üî Fiat via Deutsche Bank</h3>

<h4>5.1 Inflow (Fiat ‚Üí Crypto ‚Üí MetaMask)</h4>

<strong>Flow:</strong>
1. User √ºberweist EUR via SEPA auf Deutsche Bank Corporate Account
2. Deutsche Bank API meldet eingehende Transaktion
3. System konvertiert EUR ‚Üí ETH/Stablecoin via regulierte Exchange
4. Crypto wird an MetaMask-Wallet gesendet

<strong>API-Implementation:</strong>
```javascript
async function handleFiatInflow(dbTransaction) {
  // 1. Transaktion von Deutsche Bank empfangen
  const creditAmount = dbTransaction.amount; // EUR
  
  // 2. Exchange Order: EUR ‚Üí ETH
  const exchangeOrder = await createExchangeOrder({
    from: 'EUR',
    to: 'ETH',
    amount: creditAmount,
    exchange: 'REGULATED_EXCHANGE_NAME'
  });
  
  // 3. Warte auf Exchange-Ausf√ºhrung
  const cryptoAmount = await waitForExchangeCompletion(exchangeOrder.id);
  
  // 4. Transfer zu MetaMask Wallet
  await transferToMetaMask({
    amount: cryptoAmount,
    currency: 'ETH',
    walletAddress: userMetaMaskAddress
  });
  
  // 5. Log in TELBANK System
  await logTelbankFlow({
    direction: 'in',
    fiatAmount: creditAmount,
    fiatCurrency: 'EUR',
    cryptoAmount: cryptoAmount,
    cryptoSymbol: 'ETH',
    source: 'Deutsche Bank',
    dbTransactionId: dbTransaction.transaction_id
  });
}
```

<h4>5.2 Outflow (MetaMask ‚Üí Crypto ‚Üí Fiat ‚Üí Deutsche Bank)</h4>

<strong>Flow:</strong>
1. User sendet Crypto von MetaMask an Exchange
2. Exchange konvertiert Crypto ‚Üí EUR
3. System initiiert SEPA-√úberweisung via Deutsche Bank API
4. Fiat wird auf Deutsche Bank Account gutgeschrieben

<strong>API-Implementation:</strong>
```javascript
async function handleCryptoOutflow(cryptoAmount, targetIBAN) {
  // 1. Crypto von MetaMask an Exchange senden
  const exchangeDeposit = await depositToExchange({
    amount: cryptoAmount,
    currency: 'ETH'
  });
  
  // 2. Exchange: ETH ‚Üí EUR
  const exchangeOrder = await createExchangeOrder({
    from: 'ETH',
    to: 'EUR',
    amount: cryptoAmount,
    exchange: 'REGULATED_EXCHANGE_NAME'
  });
  
  const fiatAmount = await waitForExchangeCompletion(exchangeOrder.id);
  
  // 3. SEPA-√úberweisung via Deutsche Bank API
  const payment = await deutscheBankClient.initiatePayment({
    creditorAccount: {
      iban: targetIBAN
    },
    instructedAmount: {
      currency: 'EUR',
      amount: fiatAmount.toString()
    },
    remittanceInformationUnstructured: 'Together Systems TPGA Telbank Withdrawal',
    requestedExecutionDate: new Date().toISOString().split('T')[0]
  });
  
  // 4. Log in TELBANK System
  await logTelbankFlow({
    direction: 'out',
    fiatAmount: fiatAmount,
    fiatCurrency: 'EUR',
    cryptoAmount: cryptoAmount,
    cryptoSymbol: 'ETH',
    destination: 'Deutsche Bank',
    dbPaymentId: payment.paymentId
  });
}
```

---

<h2>üîí SICHERHEIT & BEST PRACTICES</h2>

<h3>6. Security Measures</h3>

<h4>6.1 Certificate Storage</h4>
- ‚úÖ Zertifikate in Cloudflare Workers Secrets oder Vault
- ‚úÖ Private Keys niemals in Code oder Git
- ‚úÖ Zertifikats-Rotation (alle 1-2 Jahre)
- ‚úÖ Certificate Revocation List (CRL) pr√ºfen

<h4>6.2 API Security</h4>
- ‚úÖ Rate Limiting (Deutsche Bank Limits beachten)
- ‚úÖ Request ID Tracking (X-Request-ID Header)
- ‚úÖ Idempotency Keys f√ºr Payments
- ‚úÖ TLS 1.3 f√ºr alle Verbindungen
- ‚úÖ IP Whitelisting (wenn verf√ºgbar)

<h4>6.3 Data Protection</h4>
- ‚úÖ GDPR-konforme Datenverarbeitung
- ‚úÖ PII-Verschl√ºsselung (at rest & in transit)
- ‚úÖ Audit-Logging aller API-Calls
- ‚úÖ Data Retention Policies

---

<h2>üìä MONITORING & ERROR HANDLING</h2>

<h3>7. Error Handling</h3>

<h4>7.1 Deutsche Bank API Error Codes</h4>

```javascript
const DB_ERROR_CODES = {
  'DB001': 'Invalid certificate',
  'DB002': 'Certificate expired',
  'DB003': 'Insufficient funds',
  'DB004': 'Invalid IBAN',
  'DB005': 'Account not found',
  'DB006': 'Transaction limit exceeded',
  'DB007': 'KYC verification required',
  'DB008': 'AML check failed',
  'DB009': 'Rate limit exceeded',
  'DB010': 'Service temporarily unavailable'
};

async function handleDeutscheBankError(error) {
  const errorCode = error.code;
  
  switch (errorCode) {
    case 'DB001':
    case 'DB002':
      // Certificate-Problem ‚Üí Alert Admin, Certificate erneuern
      await alertAdmin('Certificate issue detected');
      break;
    case 'DB003':
      // Insufficient funds ‚Üí User informieren
      return { success: false, message: 'Insufficient funds in account' };
    case 'DB007':
      // KYC required ‚Üí KYC-Prozess starten
      await triggerKYCProcess();
      break;
    case 'DB009':
      // Rate limit ‚Üí Exponential Backoff
      await sleep(exponentialBackoff(retryCount));
      break;
    default:
      // Generic error ‚Üí Log & Alert
      console.error('Deutsche Bank API Error:', error);
      await logError(error);
  }
}
```

<h4>7.2 Retry Logic</h4>

```javascript
async function retryWithBackoff(fn, maxRetries = 3) {
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await fn();
    } catch (error) {
      if (error.code === 'DB009' && i < maxRetries - 1) {
        // Rate limit ‚Üí wait exponential
        await sleep(Math.pow(2, i) * 1000);
        continue;
      }
      throw error;
    }
  }
}
```

---

<h2>üöÄ DEPLOYMENT & PRODUCTION-READINESS</h2>

<h3>8. Prototyp-Anforderungen</h3>

<h4>8.1 Deutsche Bank Partner-Prozess</h4>

<strong>Phase 1: Initial Contact</strong>
- ‚úÖ Kontakt zu Deutsche Bank Corporate Banking
- ‚úÖ Gesch√§ftskonzept pr√§sentieren
- ‚úÖ KYC/AML-Prozess starten

<strong>Phase 2: Sandbox Access</strong>
- ‚úÖ API-Zugangsdaten f√ºr Sandbox erhalten
- ‚úÖ Test-Zertifikate beantragen
- ‚úÖ Sandbox-Integration testen

<strong>Phase 3: Production Setup</strong>
- ‚úÖ Production-Zertifikate beantragen
- ‚úÖ Production API-Credentials erhalten
- ‚úÖ Go-Live mit kleineren Betr√§gen

<h4>8.2 Checkliste f√ºr Production</h4>

- [ ] Deutsche Bank Corporate Account er√∂ffnet
- [ ] KYC/AML-Prozess abgeschlossen
- [ ] Production-Zertifikate erhalten
- [ ] API-Credentials konfiguriert
- [ ] Sandbox-Tests erfolgreich
- [ ] Error-Handling implementiert
- [ ] Monitoring & Alerting eingerichtet
- [ ] Compliance-Dokumentation erstellt
- [ ] BaFin-Meldepflichten gekl√§rt

---

<h2>üìö REFERENZEN & LINKS</h2>

<h3>Deutsche Bank API Documentation</h3>
- <strong>Developer Portal:</strong> https://developer.db.com
- <strong>PSD2 API Docs:</strong> https://developer.db.com/psd2
- <strong>Corporate Banking API:</strong> https://developer.db.com/corporate-banking
- <strong>Sandbox Environment:</strong> https://api-sandbox.db.com

<h3>Regulatory</h3>
- <strong>BaFin:</strong> https://www.bafin.de
- <strong>PSD2 Regulation:</strong> EU Directive 2015/2366
- <strong>EIDAS:</strong> https://eidas.europa.eu

<h3>Together Systems Integration</h3>
- <strong>TELBANK System:</strong> `TELBANK/README.md`
- <strong>TPGA Overview:</strong> `TELBANK/TPGA-TELBANK-SYSTEM-OVERVIEW.md`
- <strong>Master Documentation:</strong> `GESAMTSYSTEM-MASTER-DOKUMENTATION.md`

---

<strong>Erstellt:</strong> 2025-01-15  
<strong>Version:</strong> 1.0.0-XXXL-DB-INTEGRATION  
<strong>Branding:</strong> T,.&T,,.&T,,,.(C)TEL1.NL  
<strong>Status:</strong> Prototyp-Bereit f√ºr Deutsche Bank Partnerschaft
</body>
</html>