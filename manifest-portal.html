<!doctype html>
<html lang="de">
<head>
  <meta name="ts-branding" content="T,.&T,,.&T,,,.TOGETHERSYSTEMS. INTERNATIONAL TTT T,.&T,,.T,,,.(C) (+31) - ( 613 803 782.) https://orcid.org/0009-0003-1328-2430">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Manifest of Thinkers â€“ Portal</title>
<style>
:root{
	--bg:#0f1419;
	--card:#111827;
	--ink:#e5e7eb;
	--muted:#9ca3af;
	--accent:#10b981;
	--accent-2:#f59e0b;
	--border:#1f2937;
	--radius:14px;
	/* Ambient-Overlay wird von ambient-media.js gesetzt (neon/grÃ¼n, â€Sunset-Stripâ€œ-GefÃ¼hl) */
	--ambient-overlay: radial-gradient(420px 260px at 5% 105%, rgba(34,197,94,0.25), transparent 70%);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
	margin:0;background:linear-gradient(180deg,#0b0f14,#0f1419 50%,#0b0f14);
	color:var(--ink);font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Ubuntu,Oxygen,Cantarell,"Helvetica Neue",Arial,sans-serif;
}
.wr{max-width:1200px;margin:0 auto;padding:18px}
.hero{
	border-radius:22px;padding:20px;border:1px solid var(--border);
	background:
		radial-gradient(600px 200px at 10% 0%,#10b98122,transparent 60%),
		radial-gradient(600px 200px at 90% 0%,#f59e0b22,transparent 60%),
		var(--ambient-overlay),
		var(--card);
	position:relative;
	overflow:hidden;
}
/* Leichter Lichtblitz beim Theme-Wechsel */
.hero.ambient-pulse::after{
	content:'';
	position:absolute;
	inset:-20%;
	background:radial-gradient(circle at 10% -10%,rgba(190,242,100,0.35),transparent 60%);
	mix-blend-mode:screen;
	opacity:0;
	pointer-events:none;
	animation:ambientPulse 900ms ease-out forwards;
}
@keyframes ambientPulse{
	0%{opacity:0;}
	20%{opacity:0.8;}
	100%{opacity:0;}
}
.header{display:flex;align-items:center;gap:14px}
.badge{width:46px;height:46px;border-radius:50%;display:grid;place-items:center;background:var(--accent);color:#00110b;font-weight:800}
h1{margin:0;font-size:22px}
.sub{color:var(--muted);font-size:13px}
.grid{display:grid;gap:18px;grid-template-columns:1.2fr .8fr;margin-top:18px}
.panel{background:var(--card);border:1px solid var(--border);border-radius:var(--radius)}
.pad{padding:16px}
.title{font-size:14px;color:#d1d5db;margin:0 0 8px}
.btn{background:var(--accent);color:#00110b;border:none;border-radius:999px;padding:10px 14px;font-weight:700;cursor:pointer}
.btn.alt{background:#1f2937;color:#e5e7eb;border:1px solid var(--border)}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
input[type="file"]{display:none}
input[type="url"], input[type="text"]{
	width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0b0f14;color:var(--ink)
}
.pill{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:#0b0f14;color:#d1d5db;font-size:12px}
.feed{padding:0}
.entry{padding:16px;border-top:1px solid var(--border)}
.entry:first-child{border-top:none}
.entry h3{margin:0 0 6px;font-size:18px}
.meta{color:var(--muted);font-size:12px}
.reactions{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.reaction{border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:#0b0f14}
.comment{margin-top:8px;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#0b0f14}
.muted{color:var(--muted);font-size:12px}
.kbd{background:#0b0f14;border:1px solid var(--border);border-bottom-width:2px;padding:8px 10px;border-radius:10px;color:#d1d5db;white-space:pre-wrap;max-height:260px;overflow:auto}
.grid-2{display:grid;gap:12px;grid-template-columns:1fr 1fr}
.warn{color:#fbbf24}
.ok{color:#34d399}
.live-chat{
	border-top:1px solid var(--border);
	margin-top:8px;
	padding-top:8px;
}
.live-chat-messages{
	max-height:220px;
	overflow-y:auto;
	margin-bottom:8px;
	font-size:13px;
}
.live-chat-message{
	margin-bottom:4px;
}
.live-chat-message .meta{
	font-size:11px;
	color:var(--muted);
}
.live-chat-input{
	display:flex;
	gap:6px;
	align-items:center;
}
.live-chat-input input{
	flex:1;
	min-width:0;
	padding:6px 8px;
	border-radius:10px;
	border:1px solid var(--border);
	background:#0b0f14;
	color:var(--ink);
}

/* Public copy-protection (soft) */
.public-view .content{user-select:none;-webkit-user-select:none}
.public-view *{ -webkit-touch-callout:none }
/* Harder attempts */
body.public-view{ --cursor: not-allowed }
.public-view .content::selection { background: transparent }

.dimmed-feed .entry{
	opacity:0.4;
	filter:grayscale(0.3);
}

/* TogetherSystems Branding-Leiste */
.ts-brand-banner{
  background:linear-gradient(90deg,#020617,#0f172a 50%,#111827);
  color:#e5e7eb;
  padding:4px 12px;
  font-size:11px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:6px;
  border-bottom:1px solid rgba(148,163,184,.45);
}
.ts-brand-banner strong{font-weight:600;}
.ts-brand-sub{opacity:.78; display:block;}
.ts-brand-links a{
  color:#a5b4fc;
  text-decoration:none;
  font-size:11px;
  margin-left:8px;
  white-space:nowrap;
}
.ts-brand-links a:hover{text-decoration:underline;}

.voucher-layout{
	display:grid;
	grid-template-columns:1.4fr .9fr;
	gap:16px;
}
@media(max-width:960px){
	.voucher-layout{grid-template-columns:1fr;}
}
.voucher-list{
	display:flex;
	flex-direction:column;
	gap:10px;
}
.voucher-card{
	border:1px solid var(--border);
	border-radius:12px;
	padding:10px 12px;
	background:#0b0f14;
	cursor:pointer;
}
.voucher-card-header{
	display:flex;
	justify-content:space-between;
	align-items:center;
	margin-bottom:4px;
}
.voucher-badge{
	font-size:11px;
	padding:2px 6px;
	border-radius:999px;
	border:1px solid var(--border);
}
.voucher-badge.status-issued{border-color:#38bdf8;color:#bae6fd;}
.voucher-badge.status-booked{border-color:#22c55e;color:#bbf7d0;}
.voucher-badge.status-consumed{border-color:#a855f7;color:#e9d5ff;}
.voucher-badge.status-expired{border-color:#f97373;color:#fee2e2;}
.voucher-meta{
	font-size:11px;
	color:var(--muted);
}
.slot-calendar{
	margin-top:8px;
	border-top:1px dashed var(--border);
	padding-top:6px;
	font-size:11px;
	color:var(--muted);
	display:flex;
	flex-direction:column;
	gap:4px;
}
.slot-calendar-day{
	display:flex;
	justify-content:space-between;
	align-items:center;
}
.slot-calendar-badges{
	display:flex;
	gap:4px;
	flex-wrap:wrap;
}
.slot-list{
	display:flex;
	flex-direction:column;
	gap:6px;
	font-size:12px;
}
.slot-item{
	display:flex;
	justify-content:space-between;
	align-items:center;
	border:1px solid var(--border);
	border-radius:10px;
	padding:6px 8px;
	background:#020617;
}

</style>
</head>
<body class="public-view">
  <div class="ts-brand-banner">
    <div>
      <strong>T,.&T,,.&T,,,.TOGETHERSYSTEMS. INTERNATIONAL TTT T,.&T,,.T,,,.(C)</strong>
      <span class="ts-brand-sub">(+31) - ( 613 803 782.) https://orcid.org/0009-0003-1328-2430</span>
    </div>
    <div class="ts-brand-links">
      <a href="./index.html">â† ZurÃ¼ck</a>
      <a href="./index.html">Portal</a>
      <a href="./help-portal.html">Portal-Hilfe</a>
      <a href="./manifest-forum.html">Manifest</a>
      <a href="./help-manifest.html">Manifest-Hilfe</a>
      <a href="./manifest-portal.html">Online-Portal</a>
      <a href="./help-online-portal.html">Online-Portal-Hilfe</a>
      <a href="./honeycomb.html">WabenrÃ¤ume</a>
      <a href="./help-honeycomb.html">WabenrÃ¤ume-Hilfe</a>
      <a href="./legal-hub.html">Legal-Hub</a>
      <a href="./help-legal-hub.html">Legal-Hub-Hilfe</a>
      <a href="./TELBANK/index.html" title="TPGA Telbank â€“ MetaMask Liquidity Console">ğŸ’° Telbank</a>
      <a href="./business-admin.html" title="Business-Admin â€“ Vouchers & Buchungen">ğŸ“Š Business-Admin</a>
      <a href="./admin-monitoring.html" title="Monitoring & Events">ğŸ“ˆ Monitoring</a>
      <a href="./TsysytemsT/TsysytemsT.html" title="One Network Â· One Humanity Â· OPS / OSP">ğŸŒ One&nbsp;Network</a>
      <a href="https://www.gofundme.com/f/magnitudo?utm_campaign=unknown&amp;utm_medium=referral&amp;utm_source=widget" target="_blank" rel="noopener" title="Teilnahme an der Einsammlung (5â€“33.000&nbsp;â‚¬)">ğŸ’  UnterstÃ¼tzen</a>
      <a href="https://www.tinyurl.com/bugcompany" target="_blank" rel="noopener" title="GroÃŸunternehmen &amp; Stiftungen">ğŸ›ï¸ Big&nbsp;Support</a>
    </div>
  </div>

	<div class="wr">
		<div class="hero" data-ambient-slot="hero-portal">
			<div class="header">
				<div class="badge">MoT</div>
				<div>
					<h1>Manifest of Thinkers â€“ Portal</h1>
					<div class="sub">Ã–ffentliche Ansicht (nur lesen) Â· Verifizierte Nutzer schalten Live-Funktionen frei</div>
				</div>
			</div>
			<div class="row" style="margin-top:10px">
				<span class="pill" title="Nur verifizierte Nutzer mit Offline-Datei">Zugang: eingeschrÃ¤nkt</span>
				<span class="pill">Multilingual</span>
				<span class="pill">Business & Teams</span>
				<span class="pill">Kontrakte & Transfer</span>
			</div>
			<div class="row" style="margin-top:10px">
				<button class="btn alt" id="bonusBtn" type="button">
					Bonus-Ã–kosystem &amp; Modulâ€‘Mesh anzeigen
				</button>
			</div>
		</div>

		<div class="grid" style="margin-top:18px">
			<main class="panel feed" id="feed"></main>
			<aside class="panel">
				<div class="pad">
					<h3 class="title">Verifizierung (nur Offline-Forum-Nutzer)</h3>
					<div class="grid-2">
						<input id="token" type="text" placeholder="Token aus Offline-Forum (automatisch via Link)">
						<button class="btn" id="verifyBtn">Verifizieren</button>
					</div>
					<p class="muted">Wenn du das Offline-Forum nutzt und Ã¼ber â€Portal Ã¶ffnenâ€œ kommst, wird der Token automatisch im Link Ã¼bergeben. Manuell kannst du ihn hier einfÃ¼gen.</p>
				</div>
				<div class="pad" style="border-top:1px solid var(--border)">
					<h3 class="title">Token-URL generieren (No-Code)</h3>
					<p class="muted">Gib ein Basisâ€‘Token ein, klicke auf â€URL generierenâ€œ und kopiere die fertige Portalâ€‘Adresse inklusive <code>#mot</code>, <code>ts</code> und <code>sig</code>.</p>
					<div class="grid-2">
						<input id="genBaseToken" type="text" placeholder="Dein Basisâ€‘Token (z. B. mot-shared-token-v1)">
						<button class="btn alt" id="generateUrlBtn" type="button">URL generieren</button>
					</div>
					<p class="muted" style="margin-top:6px">Fertige URL (kann 1:1 weitergegeben werden):</p>
					<textarea id="generatedUrl" class="kbd" readonly rows="3" style="width:100%;min-height:72px;"></textarea>
				</div>
				<div class="pad" style="border-top:1px solid var(--border)">
					<h3 class="title">Daten laden</h3>
					<div class="row">
						<label for="jsonFile" class="btn alt" style="cursor:pointer">JSON importieren</label>
						<input id="jsonFile" type="file" accept="application/json">
						<button class="btn alt" id="payloadBtn">Payload anzeigen</button>
					</div>
					<p class="muted">FÃ¼r Live-Betrieb kann hier eine API-Quelle konfiguriert werden.</p>
					<div style="margin-top:10px">
						<select id="apiPreset" class="muted" style="width:100%;margin-bottom:6px;background:#0b0f14;border:1px solid var(--border);border-radius:10px;padding:6px 8px;">
							<option value="">API-Vorlage wÃ¤hlen (optional)</option>
							<option value="supabase">Supabase REST (Beispiel)</option>
							<option value="firebase">Firebase Callable (Beispiel)</option>
							<option value="custom">Eigene URL (manuell)</option>
						</select>
						<input id="apiUrl" type="url" placeholder="https://deine-seite.tld/api/manifest/list">
						<div class="row" style="margin-top:8px">
							<button class="btn" id="fetchBtn">Von API laden</button>
							<button class="btn alt" id="clearBtn">Feed leeren</button>
						</div>
					</div>
					<pre class="kbd" id="payloadBox" hidden></pre>
				</div>
				<div class="pad" style="border-top:1px solid var(--border)">
					<h3 class="title">Admin-Moderation</h3>
					<p class="muted">Werkzeuge, um den Ã¶ffentlichen Feed lokal zu steuern (nur in diesem Browser wirksam).</p>
					<div class="row">
						<button class="btn alt" id="verbergenBtn" type="button">BeitrÃ¤ge verbergen</button>
						<button class="btn alt" id="sichtbarBtn" type="button">BeitrÃ¤ge sichtbar machen</button>
						<button class="btn alt" id="statsBtn" type="button">Statistik anzeigen</button>
					</div>
					<div class="row" style="margin-top:6px;">
						<select id="moderationScope" class="muted" style="width:100%;background:#0b0f14;border:1px solid var(--border);border-radius:10px;padding:6px 8px;">
							<option value="local">Nur dieser Browser</option>
							<option value="session">Aktuelle Sitzung</option>
						</select>
					</div>
					<p class="muted" id="moderationStatus" style="font-size:11px;margin-top:4px;">Noch keine Moderations-Aktion ausgefÃ¼hrt.</p>
				</div>
				<div class="pad" style="border-top:1px solid var(--border)">
					<h3 class="title">Live-Funktionen (Zero-Input-Flow)</h3>
					<p class="muted" style="margin-bottom:8px;">Ein-Klick-Kommunikation â€“ keine Konfiguration nÃ¶tig.</p>
					<div class="row" style="gap:6px;margin-bottom:8px;">
						<button class="btn" id="quickCallBtn" type="button" style="flex:1;">ğŸ“ Call starten</button>
						<button class="btn" id="quickChatBtn" type="button" style="flex:1;">ğŸ’¬ Chat starten</button>
						<button class="btn" id="quickGroupBtn" type="button" style="flex:1;">ğŸ‘¥ Gruppe starten</button>
					</div>
					<div class="row" style="margin-top:8px;">
						<select id="signalPreset" class="muted" style="width:100%;margin-bottom:6px;background:#0b0f14;border:1px solid var(--border);border-radius:10px;padding:6px 8px;">
							<option value="">Signaling-Vorlage wÃ¤hlen (optional)</option>
							<option value="cloudflare">Cloudflare Pages WebSocket (automatisch)</option>
							<option value="local">Lokaler Server (localhost:3100)</option>
							<option value="twilio">Twilio Video (Beispiel)</option>
							<option value="ably">Ably Realtime (Beispiel)</option>
							<option value="custom">Eigene WSS-URL (manuell)</option>
						</select>
					</div>
					<div class="row">
						<input id="signalUrl" type="url" placeholder="wss://signaling.deine-seite.tld (optional)">
						<button class="btn alt" id="initLiveBtn">Live initialisieren</button>
					</div>
					<p class="muted" style="font-size:11px;margin-top:4px;">Signaling wird automatisch erkannt. Buttons oben starten sofort ohne Konfiguration.</p>
				</div>
				<div class="pad" style="border-top:1px solid var(--border)">
					<h3 class="title">Hidden Viewer, Medien &amp; Datei-Transfer</h3>
					<p class="muted">
						Dieser Bereich bÃ¼ndelt die UI fÃ¼r einen versteckten Viewer, einfache Medien-Steuerung
						und einen R2â€‘Dateiâ€‘Transfer (Demoâ€‘Status, ohne Pflichtâ€‘Backend).
					</p>
					<div class="row" style="margin-top:4px;">
						<button class="btn alt" id="loadHiddenBtn" type="button">Hidden Viewer laden</button>
					</div>
					<div class="row" style="margin-top:8px;">
						<input id="filePick" type="file" multiple>
						<span class="muted" id="filePickStatus" style="font-size:11px;">Noch keine Dateien ausgewÃ¤hlt.</span>
					</div>
					<div class="row" style="margin-top:4px;">
						<input id="p2pFileInput" type="file" multiple>
						<span class="muted" style="font-size:11px;">P2Pâ€‘Dateiâ€‘Transfer (Demoâ€‘Eingang, optionales Mesh/R2â€‘Backend).</span>
					</div>
					<div class="row" style="margin-top:8px;">
						<button class="btn alt" id="startMediaBtn" type="button">Media starten</button>
						<button class="btn alt" id="stopMediaBtn" type="button">Media stoppen</button>
					</div>
					<p class="muted" id="mediaStatus" style="font-size:11px;margin-top:4px;">Media-/Streams sind noch inaktiv.</p>
				</div>
				<div class="pad" style="border-top:1px solid var(--border)">
					<h3 class="title">Live-Raum erstellen (No-Code)</h3>
					<p class="muted">Definiere einen Raum komplett Ã¼ber Formular. Das Portal erzeugt das passende JSON fÃ¼r dein Backend.</p>
					<div class="row">
						<select id="roomType" style="flex:1;min-width:120px;background:#0b0f14;border:1px solid var(--border);border-radius:10px;padding:6px 8px;color:var(--fg);">
							<option value="text">Textâ€‘Raum</option>
							<option value="video">Videoâ€‘Raum</option>
							<option value="file">Dateiâ€‘Austausch</option>
							<option value="contract">Vertragsâ€‘Raum</option>
						</select>
						<input id="roomId" type="text" placeholder="Raum-ID (z. B. post-123 oder wabe A-2)" style="flex:1;min-width:160px;">
					</div>
					<p class="muted" style="margin-top:6px">Rechte in diesem Raum:</p>
					<div class="row" style="font-size:12px;color:var(--muted);margin-top:2px">
						<label><input type="checkbox" id="permRead" checked> lesen</label>
						<label><input type="checkbox" id="permSend" checked> senden</label>
						<label><input type="checkbox" id="permSign"> unterschreiben</label>
						<label><input type="checkbox" id="permUpload"> hochladen</label>
					</div>
					<div class="row" style="margin-top:8px">
						<button class="btn alt" id="buildRoomJsonBtn" type="button" aria-label="Raum-JSON anzeigen">Raum-JSON anzeigen</button>
					</div>
					<pre class="kbd" id="roomJsonBox" style="margin-top:6px;min-height:80px;"></pre>
					<p class="muted">Dieses JSON kannst du 1:1 an dein Backend (API oder Signalingâ€‘Server) weitergeben.</p>
				</div>
				<div class="pad" style="border-top:1px solid var(--border)">
					<h3 class="title">Direktverbinden (Autoâ€‘Connect)</h3>
					<p class="muted">Optionales Stichwort, um dich mit anderen Thinkern zu koppeln (z.â€¯B. â€projekt_alphaâ€œ, â€familieâ€œ, â€beratungâ€œ). Das Matching lÃ¤uft automatisch im Hintergrund.</p>
					<label class="muted" style="font-size:12px;display:block;margin-bottom:4px;">
						Raum-Stichwort:
						<input id="pairCodeInput" type="text" placeholder="z.B. projekt_alpha, familie, beratung">
					</label>
					<div class="muted" id="connectStatus" style="font-size:12px;margin-top:4px;">
						Warte auf Verbindungsaufbau â€¦
					</div>
				</div>
			</aside>
		</div>
		<section class="panel" id="business-sectors" style="margin-top:18px;">
			<div class="pad">
				<h3 class="title">GeschÃ¤ftsbereiche &amp; VertrÃ¤ge (Ãœberblick)</h3>
				<p class="muted">
					Das Portal ist nicht nur ein Nachrichtenâ€‘Feed, sondern eine Schaltzentrale fÃ¼r verschiedene GeschÃ¤ftsbereiche,
					in denen echte Kontrakte und Transaktionen ablaufen kÃ¶nnen. Die wichtigsten Bausteine:
				</p>
				<div class="row" style="margin-top:8px;flex-wrap:wrap;gap:10px;">
					<div style="flex:1 1 220px;min-width:220px;border:1px solid var(--border);border-radius:12px;padding:10px;">
						<div class="title" style="font-size:13px;margin-bottom:4px;">ğŸ  HÃ¤usermarkt &amp; Hypotheken</div>
						<p class="muted" style="font-size:12px;margin:0 0 4px;">
							Immobilienâ€‘Anfragen, Angebote und VertrÃ¤ge fÃ¼r HÃ¤user/Wohnungen. Beispielâ€‘Flow im
							Bereich â€Immobilien &amp; Hypotheken (Demo)â€œ.
						</p>
						<p class="muted" style="font-size:11px;margin:0;">
							<a href="#mortgage-panel">Zum HÃ¤usermarktâ€‘Demo springen</a>
						</p>
					</div>
					<div style="flex:1 1 220px;min-width:220px;border:1px solid var(--border);border-radius:12px;padding:10px;">
						<div class="title" style="font-size:13px;margin-bottom:4px;">ğŸ’¼ Unternehmensfinanzierung &amp; Kredite</div>
						<p class="muted" style="font-size:12px;margin:0 0 4px;">
							Firmenâ€‘Kredite, Zwischenfinanzierungen und Projektâ€‘Deals kÃ¶nnen Ã¼ber denselben Mechanismus wie Hypotheken
							abgebildet werden (Anfrage â†’ Angebot â†’ Vertrag).
						</p>
						<p class="muted" style="font-size:11px;margin:0;">
							Technischer Anker: Hypothekenâ€‘API + Voucherâ€‘System.
						</p>
					</div>
					<div style="flex:1 1 220px;min-width:220px;border:1px solid var(--border);border-radius:12px;padding:10px;">
						<div class="title" style="font-size:13px;margin-bottom:4px;">ğŸ« Events, Sessions &amp; Termine</div>
						<p class="muted" style="font-size:12px;margin:0 0 4px;">
							Beratung, Therapie, Coaching, Unterricht, Konferenzen â€“ alles, was Ã¼ber Slots und Rechte gesteuert wird.
							Voucher dienen als Eintrittskarte in einen Wabenâ€‘ oder Liveâ€‘Raum.
						</p>
						<p class="muted" style="font-size:11px;margin:0;">
							<a href="#voucher-panel">Zu â€Voucher &amp; Termineâ€œ springen</a>
						</p>
					</div>
					<div style="flex:1 1 220px;min-width:220px;border:1px solid var(--border);border-radius:12px;padding:10px;">
						<div class="title" style="font-size:13px;margin-bottom:4px;">âš™ï¸ Maschinenzeit &amp; GerÃ¤te</div>
						<p class="muted" style="font-size:12px;margin:0 0 4px;">
							Stundenweise Nutzung von Maschinen, Studios, Fahrzeugen oder GerÃ¤ten. Die Plattform kann Slots, ZugÃ¤nge
							und Vertragsâ€‘PDFs bÃ¼ndeln.
						</p>
						<p class="muted" style="font-size:11px;margin:0;">
							Technischer Anker: Voucherâ€‘Slots + Legalâ€‘Hubâ€‘VertrÃ¤ge.
						</p>
					</div>
					<div style="flex:1 1 220px;min-width:220px;border:1px solid var(--border);border-radius:12px;padding:10px;">
						<div class="title" style="font-size:13px;margin-bottom:4px;">ğŸ‘¥ Mitgliedschaften &amp; Abos</div>
						<p class="muted" style="font-size:12px;margin:0 0 4px;">
							Vereine, Communities, Plattformâ€‘ZugÃ¤nge â€“ Mitgliedschaftsâ€‘Voucher verknÃ¼pfen Rechte mit Personen
							und RÃ¤umen (z.&nbsp;B. geschlossene Waben).
						</p>
						<p class="muted" style="font-size:11px;margin:0;">
							Technischer Anker: wiederverwendbare Voucherâ€‘Templates.
						</p>
					</div>
					<div style="flex:1 1 220px;min-width:220px;border:1px solid var(--border);border-radius:12px;padding:10px;">
						<div class="title" style="font-size:13px;margin-bottom:4px;">ğŸ’¶ ZahlungsflÃ¼sse &amp; Telbank</div>
						<p class="muted" style="font-size:12px;margin:0 0 4px;">
							Kryptoâ€‘Ein/AusgÃ¤nge, Bankâ€‘/Skrillâ€‘Referenzen und Abrechnung. TPGAâ€‘Telbank dokumentiert,
							wie Geld als Kommunikationsâ€‘System zwischen Wallet und klassischer Finanzwelt flieÃŸt.
						</p>
						<p class="muted" style="font-size:11px;margin:0;">
							Eigene App: <code>TELBANK/index.html</code> (MetaMask &amp; Transferâ€‘Log).
						</p>
					</div>
				</div>
			</div>
		</section>
		<section class="panel" id="voucher-panel" style="margin-top:18px;">
			<div class="pad">
				<h3 class="title" role="heading">Voucher &amp; Termine</h3>
				<p class="muted">
					Hier verwaltest du zeitbasierte Leistungen (Vouchers) und buchbare Termine. WÃ¤hle oben deine Rolle und klicke auf einen Voucher,
					um freie Slots zu sehen und Buchungen vorzunehmen. Ãœber die Branchenâ€‘Vorlagen kannst du typische Angebote mit einem Klick erstellen.
				</p>
				<div class="row" style="margin-top:8px;">
					<button class="btn alt" id="voucherModeCustomer" type="button">Ich bin Kunde</button>
					<button class="btn alt" id="voucherModeIssuer" type="button">Ich bin Anbieter</button>
					<button class="btn" id="btnVoucherRefresh" type="button">Aktualisieren</button>
				</div>
				<div class="row" style="margin-top:6px;font-size:11px;">
					<span class="muted" style="flex:1;min-width:120px;">Branchenâ€‘Vorlagen:</span>
					<button class="btn alt" type="button" data-voucher-template="consulting" style="font-size:11px;">ğŸ’¬ Beratung 60&nbsp;Min</button>
					<button class="btn alt" type="button" data-voucher-template="therapy" style="font-size:11px;">ğŸ§  Therapieâ€‘Session</button>
					<button class="btn alt" type="button" data-voucher-template="viewing" style="font-size:11px;">ğŸ  Hausâ€‘Besichtigung</button>
					<button class="btn alt" type="button" data-voucher-template="machine" style="font-size:11px;">âš™ï¸ Maschinenzeit</button>
					<button class="btn alt" type="button" data-voucher-template="membership" style="font-size:11px;">ğŸ‘¥ Membership</button>
				</div>
				<div class="voucher-layout" style="margin-top:10px;">
					<div>
						<h4 class="title" style="margin-bottom:4px;">Vouchers</h4>
						<div class="voucher-list" id="voucherList"></div>
					</div>
					<div>
						<h4 class="title" style="margin-bottom:4px;">VerfÃ¼gbare Slots</h4>
						<div class="slot-list" id="slotList"></div>
						<div class="slot-calendar" id="slotCalendar"></div>
						<p class="muted" style="font-size:10px;margin-top:4px;">
							Der Kalender fasst freie Slots pro Tag zusammen (basierend auf den vom Backend gelieferten Stundenâ€‘Slots).
						</p>
					</div>
				</div>
				<p class="muted" style="font-size:11px;margin-top:6px;">
					Die Daten kommen aus der Cloudflare Pages Functions API (/api/voucher/*). FÃ¼r lokale Entwicklung sollte hier ein lokaler Server gestartet werden.
				</p>
			</div>
		</section>
		<section class="panel" id="events-memberships-panel" style="margin-top:18px;">
			<div class="pad">
				<h3 class="title" role="heading">Events &amp; Memberships â€“ Ãœbersicht</h3>
				<p class="muted">
					Diese Ãœbersicht fasst alle Vouchers fÃ¼r Beratungsâ€‘/Therapieâ€‘Sessions und Membershipâ€‘ZugÃ¤nge zusammen,
					die du ausgestellt hast. So siehst du auf einen Blick, wie viele Events und Mitgliedschaften aktiv sind.
				</p>
				<pre class="kbd" id="eventsMembershipsOutput" style="margin-top:6px;max-height:220px;"></pre>
				<p class="muted" style="font-size:11px;margin-top:4px;">
					Technischer Hinweis: Die Daten werden aus derselben Voucherâ€‘API gelesen wie â€Voucher &amp; Termineâ€œ
					und nach <code>serviceType</code> gefiltert (<code>consulting.session</code>, <code>therapy.session</code>, <code>membership.access</code>).
				</p>
			</div>
		</section>
		<section class="panel" id="my-bookings-panel" style="margin-top:18px;">
			<div class="pad">
				<h3 class="title" role="heading">Meine Buchungen (Autopilot-Ãœbersicht)</h3>
				<p class="muted">
					Hier siehst du alle Termine, die mit deiner Browserâ€‘ID gebucht wurden.
					Die Daten kommen direkt aus der Datenbank (<code>voucher_bookings</code>).
				</p>
				<div class="slot-list" id="myBookingsList" style="margin-top:8px;"></div>
			</div>
		</section>
		<section class="panel" id="verticals-panel" style="margin-top:18px;">
			<div class="pad">
				<h3 class="title" role="heading">Vertikale Konsolen â€“ Maschinen, Events, Memberships</h3>
				<p class="muted">
					Diese drei Ãœbersichten zeigen dieselben Voucherâ€‘Daten aus unterschiedlichen Blickwinkeln:
					<strong>Maschinenzeit</strong>, <strong>Events &amp; Sessions</strong> und <strong>Memberships</strong>.
					Die Daten stammen direkt aus der D1â€‘basierten Voucherâ€‘API.
				</p>
				<div class="voucher-layout" style="margin-top:10px;">
					<div>
						<h4 class="title" style="margin-bottom:4px;">âš™ï¸ Maschinenzeit</h4>
						<table style="width:100%;border-collapse:collapse;font-size:11px;">
							<thead>
								<tr>
									<th style="border-bottom:1px solid var(--border);text-align:left;padding:4px 6px;">Maschine</th>
									<th style="border-bottom:1px solid var(--border);text-align:left;padding:4px 6px;">Standort</th>
									<th style="border-bottom:1px solid var(--border);text-align:left;padding:4px 6px;">Preis</th>
									<th style="border-bottom:1px solid var(--border);text-align:left;padding:4px 6px;">Status</th>
								</tr>
							</thead>
							<tbody id="machinesTableBody">
								<tr><td colspan="4" style="padding:4px 6px;color:var(--muted);">Noch keine Maschinenâ€‘Vouchers gefunden.</td></tr>
							</tbody>
						</table>
					</div>
					<div>
						<h4 class="title" style="margin-bottom:4px;">ğŸ« Events &amp; ğŸ‘¥ Memberships</h4>
						<table style="width:100%;border-collapse:collapse;font-size:11px;">
							<thead>
								<tr>
									<th style="border-bottom:1px solid var(--border);text-align:left;padding:4px 6px;">Typ</th>
									<th style="border-bottom:1px solid var(--border);text-align:left;padding:4px 6px;">Titel</th>
									<th style="border-bottom:1px solid var(--border);text-align:left;padding:4px 6px;">Status</th>
									<th style="border-bottom:1px solid var(--border);text-align:left;padding:4px 6px;">Zeitraum</th>
								</tr>
							</thead>
							<tbody id="eventsMembershipsTableBody">
								<tr><td colspan="4" style="padding:4px 6px;color:var(--muted);">Noch keine Events/Memberships gefunden.</td></tr>
							</tbody>
						</table>
					</div>
				</div>
				<p class="muted" style="font-size:11px;margin-top:6px;">
					Technischer Hinweis: Maschinenzeit nutzt <code>serviceType='machine.timeslot'</code>,
					Events <code>consulting.session</code>/<code>therapy.session</code>/<code>realestate.viewing</code>,
					Memberships <code>membership.access</code>. Alle Daten kommen aus <code>/api/voucher/list</code>.
				</p>
			</div>
		</section>
		<section class="panel" style="margin-top:18px;">
			<div class="pad">
				<h3 class="title">Gesellschaftlicher Pfeiler Â· Freiwillige Beteiligung</h3>
				<p class="muted">
					TogetherSystems ist wie eine Armbanduhr mit GÃ¼rtelschnalle: Offlineâ€‘Manifest und Onlineâ€‘Portal schnappen zusammen,
					sobald du â€onlineâ€œ gehst â€“ und lÃ¶sen sich wieder, wenn du das GerÃ¤t trennst. Dieses dauerhafte Zusammenspiel verdient
					eine freiwillige Beteiligung derjenigen, die es regelmÃ¤ÃŸig nutzen.
				</p>
				<p class="muted">
					Mit jedem Beitrag zwischen <strong>5&nbsp;â‚¬</strong> und <strong>33.000&nbsp;â‚¬</strong> hilfst du, diesen Pfeiler zu stabilisieren
					und weitere Projekte des Producers (Ã¼ber 500 geplante Pfeiler) zu ermÃ¶glichen. Nach Erreichen der 33.000&nbsp;â‚¬ kann die Plattform
					in Absprache mit FÃ¶rderern weiter ausgebaut werden.
				</p>
				<div class="row" style="margin-top:6px;">
					<a class="btn" href="https://www.gofundme.com/f/magnitudo?utm_campaign=unknown&amp;utm_medium=referral&amp;utm_source=widget" target="_blank" rel="noopener">
						ğŸ’  Beitrag 5â€“33.000&nbsp;â‚¬
					</a>
					<a class="btn alt" href="https://www.tinyurl.com/bugcompany" target="_blank" rel="noopener">
						ğŸ›ï¸ GroÃŸunternehmen / Stiftungen
					</a>
				</div>
				<p class="muted" style="margin-top:6px;font-size:11px;">
					Die Nutzung des Portals bleibt frei, ohne Accounts und ohne Paywall. Die Einsammlung ist ein Zusatzâ€‘Kanal fÃ¼r alle,
					die das System als dauerhaften gesellschaftlichen Baustein sehen.
				</p>
			</div>
		</section>
		<section class="panel" id="yfood-sponsor" style="margin-top:18px;">
			<div class="pad">
				<h3 class="title">ğŸ½ï¸ YFood â€“ Complete Food &amp; Trink-Food</h3>
				<p class="muted">
					YFood bietet vollstÃ¤ndige Mahlzeiten und GetrÃ¤nke fÃ¼r unterwegs. Perfekt fÃ¼r alle, die sich ausgewogen ernÃ¤hren mÃ¶chten, ohne Zeit zu verlieren.
				</p>
				<div style="margin-top:12px;position:relative;padding-bottom:56.25%;height:0;overflow:hidden;border-radius:12px;border:1px solid var(--border);">
					<iframe 
						style="position:absolute;top:0;left:0;width:100%;height:100%;" 
						src="https://www.youtube.com/embed/ZYOQiBDsZo0" 
						title="YFood Werbung" 
						frameborder="0" 
						allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
						allowfullscreen>
					</iframe>
				</div>
				<p class="muted" style="margin-top:8px;font-size:11px;">
					<a href="https://www.yfood.eu" target="_blank" rel="noopener" style="color:var(--accent);">YFood auf yfood.eu entdecken</a> Â· 
					VollstÃ¤ndige Mahlzeiten &amp; Trink-Food fÃ¼r deinen Alltag
				</p>
			</div>
		</section>
		<section class="panel" id="mortgage-panel" style="margin-top:18px;">
			<div class="pad">
				<h3 class="title">Immobilien &amp; Hypotheken (Demo)</h3>
				<p class="muted">
					Dieser Bereich zeigt beispielhaft, wie der Hypotheken-Flow aus dem Meta-Transaktionsportal implementiert wird.
					Die Daten kommen aus der lokalen Mortgage-API (In-Memory).
				</p>
				<div class="row" style="margin-top:8px;">
					<button class="btn alt" id="btnLoadApplications" type="button">Meine Anfragen laden</button>
					<button class="btn alt" id="btnLoadOffers" type="button">Meine Angebote laden</button>
					<button class="btn alt" id="btnNewApplication" type="button">Beispiel-Anfrage erzeugen</button>
				</div>
				<pre class="kbd" id="mortgageOutput" style="margin-top:8px;max-height:260px;"></pre>
			</div>
		</section>
		<section class="panel" id="liveRoom" style="margin-top:18px;display:none;">
			<div class="pad">
				<h3 class="title">Live-Raum</h3>
				<p class="muted" id="liveRoomInfo">Noch kein Live-Raum aktiv. Sobald ein Match gefunden wird, erscheint hier die Verbindungsinformation.</p>
				<div class="live-chat" id="liveChat" style="display:none;">
					<h4 class="title" style="font-size:13px;margin-top:4px;">Live-Textkanal</h4>
					<div class="live-chat-messages" id="liveChatMessages"></div>
					<div class="live-chat-input">
						<input id="liveChatInput" type="text" placeholder="Nachricht eingeben und Enter drÃ¼cken â€¦">
						<button class="btn alt" id="liveChatSendBtn" type="button">Senden</button>
					</div>
					<p class="muted" style="font-size:11px;margin-top:4px;">
						Der Textkanal lÃ¤uft Ã¼ber den Signaling-Server (WebSocket). Video- und Datei-KanÃ¤le kÃ¶nnen spÃ¤ter auf derselben room_id aufsetzen.
					</p>
				</div>
			</div>
		</section>
		<section class="panel" id="suppliers-panel" style="margin-top:18px;">
			<div class="pad">
				<h3 class="title">Lieferanten &amp; Provider â€“ Milchkannen-Ãœbersicht</h3>
				<p class="muted">
					Dieser Bereich zeigt eine vereinfachte Ãœbersicht der aktuell konfigurierten Provider-Profile
					(â€Milchkannenâ€œ), die sich automatisch an das Portal anhÃ¤ngen kÃ¶nnen. Die technische Quelle ist
					<code>config/providers.json</code>. Er ist in erster Linie zur Orientierung und Dokumentation gedacht.
				</p>
				<div id="suppliersList" class="slot-list" style="margin-top:8px;"></div>
				<p class="muted" style="font-size:11px;margin-top:6px;">
					Technischer Hinweis: Die Daten werden Ã¼ber <code>router.js</code> geladen. Neue Lieferanten kÃ¶nnen
					spÃ¤ter Ã¼ber dasselbe Schema eingehÃ¤ngt werden (Bauern, Provider, AutohÃ¤ndler, weitere Branchen).
				</p>
			</div>
		</section>
	</div>

<script>
// Eingebetteter Minimal-Core, damit das Portal auch als heruntergeladene Datei (file://) funktioniert.
const MOT_STORAGE_KEYS = {
	USER_ID: 'mot_user_id_v1',
	VERIFIED: 'mot_verified_v1'
};
function generateRandomId(length = 22){
	const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
	let result = '';
	const array = new Uint32Array(length);
	if (window.crypto && window.crypto.getRandomValues) {
		window.crypto.getRandomValues(array);
		for (let i = 0; i < length; i++) {
			result += chars[array[i] % chars.length];
		}
	} else {
		for (let i = 0; i < length; i++) {
			result += chars[Math.floor(Math.random() * chars.length)];
		}
	}
	return result;
}
function getOrCreateUserId(){
	try{
		let uid = localStorage.getItem(MOT_STORAGE_KEYS.USER_ID);
		if(!uid){
			uid = generateRandomId();
			localStorage.setItem(MOT_STORAGE_KEYS.USER_ID, uid);
		}
		return uid;
	}catch{
		return generateRandomId();
	}
}
function parseHashParams(){
	const hash = window.location.hash && window.location.hash.startsWith('#')
		? window.location.hash.slice(1)
		: window.location.hash || '';
	const params = new URLSearchParams(hash);
	const obj = {};
	for (const [k, v] of params.entries()) obj[k] = v;
	return obj;
}
function markUserVerified({ uid, mot, ts, sig } = {}){
	if(!uid) uid = getOrCreateUserId();
	try{
		localStorage.setItem(MOT_STORAGE_KEYS.USER_ID, uid);
		localStorage.setItem(
			MOT_STORAGE_KEYS.VERIFIED,
			JSON.stringify({ uid, mot: mot || null, ts: ts || null, sig: sig || null })
		);
	}catch{/* ignore */}
}
function isUserVerified(){
	try{
		const raw = localStorage.getItem(MOT_STORAGE_KEYS.VERIFIED);
		if(!raw) return false;
		const data = JSON.parse(raw);
		return !!(data && data.uid);
	}catch{
		return false;
	}
}
function getUserContext(){
	const uid = getOrCreateUserId();
	const verified = isUserVerified();
	return { uid, verified };
}

const REACTIONS = [
	{key:'like', label:'GefÃ¤llt mir'},
	{key:'celebrate', label:'Gefeliciteerd'},
	{key:'support', label:'StÃ¼tzen'},
	{key:'love', label:'Gewaltig'},
	{key:'insightful', label:'Verheldernd'},
	{key:'curious', label:'Interessant'},
	{key:'entertainment', label:'Rappig'}
];

// PrÃ¤senz-/Auto-Connect-Konfiguration (Backend-Endpunkte anpassbar)
// In Cloudflare Pages/Workers-Setup: relative Route /api/presence
const PRESENCE_API_BASE = '/api/presence';
// D1-backed API base; in Produktion als Cloudflare Pages Function bereitgestellt
// Automatische Erkennung: Wenn lokal (file:// oder localhost ohne /api), dann null (keine API-Calls)
function detectVoucherApiBase() {
	// Wenn auf GitHub Pages, deaktiviere API-Calls (keine Serverless Functions)
	if (location.hostname.includes('github.io') || location.hostname.includes('github.com')) {
		console.warn('âš ï¸ GitHub Pages erkannt: API-Funktionen sind nicht verfÃ¼gbar. FÃ¼r volle FunktionalitÃ¤t deploye auf Cloudflare Pages.');
		return null;
	}
	// Wenn auf Cloudflare Pages (ts-portal.pages.dev oder Ã¤hnlich), verwende relative Pfade
	if (location.hostname.includes('pages.dev') || location.hostname.includes('workers.dev') || location.hostname.includes('cloudflare')) {
		return '/api';
	}
	// Wenn lokal (file:// oder localhost ohne API-Server), deaktiviere API-Calls
	if (location.protocol === 'file:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
		// PrÃ¼fe, ob /api verfÃ¼gbar ist (schneller Health-Check)
		return null; // Wird spÃ¤ter dynamisch geprÃ¼ft
	}
	// Standard: relative Pfade (fÃ¼r Cloudflare Pages)
	return '/api';
}
let VOUCHER_API_BASE = detectVoucherApiBase();

// Dynamische API-Base-URL-Erkennung beim Laden
(async function initApiBase() {
	if (VOUCHER_API_BASE === null) {
		// Versuche, /api zu erreichen (Health-Check)
		try {
			const testRes = await fetch('/api/voucher/list?holderUid=test', { method: 'GET' });
			if (testRes.ok || testRes.status === 400) { // 400 ist OK, bedeutet dass API existiert
				VOUCHER_API_BASE = '/api';
			} else {
				VOUCHER_API_BASE = null; // API nicht verfÃ¼gbar
			}
		} catch (e) {
			VOUCHER_API_BASE = null; // API nicht verfÃ¼gbar, deaktiviere API-Calls
			console.warn('Voucher API nicht verfÃ¼gbar. Voucher-Funktionen sind deaktiviert. FÃ¼r volle FunktionalitÃ¤t deploye auf Cloudflare Pages.');
		}
	}
})();
const HEARTBEAT_INTERVAL_MS = 25000;
const MATCH_INTERVAL_MS = 5000;
const TELEMETRY_ENDPOINT = '/api/telemetry';

/* Access control: public vs verified
   Offline-App will open portal with URL hash: #mot=TOKEN&ts=...&sig=...
   Portal verifies HMAC-SHA256(sig) over `${TOKEN}.${ts}` with shared secret name "MOT_ACCESS_TOKEN".
*/
const TOKEN_PARAM = 'mot';
const SIG_PARAM = 'sig';
const TS_PARAM = 'ts';
async function hmacSHA256Hex(key, data){
	const enc = new TextEncoder();
	const cryptoKey = await crypto.subtle.importKey('raw', enc.encode(key), {name:'HMAC', hash:'SHA-256'}, false, ['sign']);
	const sig = await crypto.subtle.sign('HMAC', cryptoKey, enc.encode(data));
	return [...new Uint8Array(sig)].map(b=>b.toString(16).padStart(2,'0')).join('');
}
function setVerifiedUI(on){
	document.body.classList.toggle('public-view', !on);
}
function updateConnectStatus(msg){
	const el = document.getElementById('connectStatus');
	if(el) el.textContent = msg;
}

// Token aus URL-Hash oder lokalem Speicher lesen (vom Offline-Manifest gesetzt)
function readManifestToken(){
	const p = parseHashParams();
	// UnterstÃ¼tzt sowohl alte SchlÃ¼ssel (token/sig/ts) als auch die aktuellen (mot/ts[/sig])
	const token = p[TOKEN_PARAM] || p.token || null;
	const ts = p[TS_PARAM] || p.ts || null;
	const sig = p[SIG_PARAM] || p.sig || null;
	if(token && ts){
		return { token, sig, ts };
	}
	try{
		const raw = localStorage.getItem('mot_token');
		if(raw){
			const obj = JSON.parse(raw);
			if(obj && obj.token){
				return obj;
			}
		}
	}catch{/* still offline */}
	return null;
}

// Mit Backend verifizieren, wer dieser Thinker ist
async function verifyTokenWithBackend(tokenObj){
	if(!tokenObj || !tokenObj.token) return null;
	if(!PRESENCE_API_BASE) return null; // API nicht verfÃ¼gbar
	try{
		const res = await fetch(`${PRESENCE_API_BASE}/verify`, {
			method:'POST',
			headers:{'Content-Type':'application/json'},
			body: JSON.stringify(tokenObj)
		});
		if(!res.ok) return null;
		const data = await res.json();
		if(!data || !data.thinker_id) return null;
		return data; // { thinker_id, pair_code? }
	}catch{
		return null;
	}
}

let currentIdentity = null;
let heartbeatTimer = null;
let matchTimer = null;
let currentRoomId = null;
let liveSocket = null;

function getEffectivePairCode(identity){
	const input = document.getElementById('pairCodeInput');
	const manual = input ? input.value.trim() : '';
	if(manual) return manual;
	if(identity && identity.pair_code) return String(identity.pair_code);
	return '';
}

function startPresenceHeartbeat(identity){
	if(!identity || !identity.thinker_id) return;
	currentIdentity = identity;
	if(heartbeatTimer) clearInterval(heartbeatTimer);

	const send = async (status='online')=>{
		if(!PRESENCE_API_BASE) return; // API nicht verfÃ¼gbar
		try{
			const pair_code = getEffectivePairCode(identity);
			await fetch(`${PRESENCE_API_BASE}/heartbeat`, {
				method:'POST',
				headers:{'Content-Type':'application/json'},
				body: JSON.stringify({
					thinker_id: identity.thinker_id,
					pair_code,
					status
				})
			});
		}catch{/* offline oder Backend noch nicht aktiv */}
	};

	// sofort einen Heartbeat senden, dann zyklisch
	send('online');
	heartbeatTimer = setInterval(()=>send('online'), HEARTBEAT_INTERVAL_MS);

	// Beim SchlieÃŸen optional "offline" melden
	window.addEventListener('beforeunload', ()=>send('offline'));

	// Wenn User den Pair-Code Ã¤ndert, nÃ¤chsten Heartbeat mit neuem Code senden
	const input = document.getElementById('pairCodeInput');
	if(input){
		input.addEventListener('input', ()=>{
			updateConnectStatus('Ã„nderung Ã¼bernommen. Warte auf zweiten Teilnehmer â€¦');
			send('online');
		});
	}
}

function startMatchLoop(identity){
	if(!identity || !identity.thinker_id) return;
	if(matchTimer) clearInterval(matchTimer);

	const liveRoom = document.getElementById('liveRoom');
	const liveRoomInfo = document.getElementById('liveRoomInfo');

		const check = async ()=>{
		if(!PRESENCE_API_BASE) {
			updateConnectStatus('Presence-API nicht verfÃ¼gbar. Bitte deploye auf Cloudflare Pages fÃ¼r volle FunktionalitÃ¤t.');
			return;
		}
		try{
			const pair_code = getEffectivePairCode(identity);
			if(!pair_code){
				updateConnectStatus('Optional: Raum-Stichwort eingeben, um automatisch verbunden zu werden.');
				return;
			}
			updateConnectStatus(`Warte auf zweiten Thinker mit Stichwort â€${pair_code}â€œâ€¦`);
			const res = await fetch(`${PRESENCE_API_BASE}/match`, {
				method:'POST',
				headers:{'Content-Type':'application/json'},
				body: JSON.stringify({
					thinker_id: identity.thinker_id,
					pair_code
				})
			});
			if(!res.ok) return;
			const data = await res.json();
			if(data && data.room_id){
				if(currentRoomId === data.room_id) return;
				currentRoomId = data.room_id;
				updateConnectStatus(`Verbunden mit Raum â€${data.room_id}â€œ. Live-Raum geÃ¶ffnet.`);
				if(liveRoom && liveRoomInfo){
					liveRoom.style.display = 'block';
					liveRoomInfo.textContent = `Du bist in Raum â€${data.room_id}â€œ mit Stichwort â€${pair_code}â€œ verbunden. Signaling-Server verbunden.`;
					initLiveChat(currentIdentity, data.room_id);
				}
			}
		}catch{
			// Backend noch nicht verfÃ¼gbar â€“ leise weiterprobieren
		}
	};

	check();
	matchTimer = setInterval(check, MATCH_INTERVAL_MS);
}

// Phase 1: Presence-Auto-Init - Automatische Verifizierung ohne Token
async function autoInitPresence(){
	// PrÃ¼fe ob bereits verifiziert
	if(currentIdentity && currentIdentity.thinker_id){
		startPresenceHeartbeat(currentIdentity);
		startMatchLoop(currentIdentity);
		return currentIdentity;
	}
	
	// Erstelle automatisch thinker_id falls nicht vorhanden
	const uid = getOrCreateUserId();
	
	// Versuche Token aus URL zu lesen
	const tokenObj = readManifestToken();
	if(tokenObj){
		const identity = await verifyTokenWithBackend(tokenObj);
		if(identity){
			setVerifiedUI(true);
			startPresenceHeartbeat(identity);
			startMatchLoop(identity);
			updateConnectStatus('Verifiziert. Warte auf zweiten Teilnehmer oder gib ein gemeinsames Raum-Stichwort ein.');
			return identity;
		}
	}
	
	// Fallback: Erstelle Identity ohne Backend-Verifikation (fÃ¼r lokale Entwicklung)
	const fallbackIdentity = {
		thinker_id: uid,
		pair_code: null
	};
	currentIdentity = fallbackIdentity;
	startPresenceHeartbeat(fallbackIdentity);
	startMatchLoop(fallbackIdentity);
	updateConnectStatus('Bereit. Gib ein gemeinsames Raum-Stichwort ein oder nutze einen Einladungslink.');
	return fallbackIdentity;
}

// Phase 2: One-Click-Match - Automatisches Matching aus URL-Parametern
async function autoConnectFromToken(){
	// PrÃ¼fe URL-Parameter fÃ¼r room/pair_code
	const urlParams = new URLSearchParams(window.location.search);
	const roomParam = urlParams.get('room') || urlParams.get('pair_code');
	
	// Wenn room-Parameter vorhanden, automatisch matchen
	if(roomParam){
		const identity = await autoInitPresence();
		if(identity){
			// Setze pair_code automatisch
			const pairCodeInput = document.getElementById('pairCodeInput');
			if(pairCodeInput){
				pairCodeInput.value = roomParam;
			}
			
			// Starte sofort Match-Loop
			updateConnectStatus(`Raum â€${roomParam}â€œ wird beigetreten â€¦`);
			
			// Warte kurz, dann prÃ¼fe Match
			setTimeout(async ()=>{
				if(PRESENCE_API_BASE){
					try{
						const res = await fetch(`${PRESENCE_API_BASE}/match`, {
							method:'POST',
							headers:{'Content-Type':'application/json'},
							body: JSON.stringify({
								thinker_id: identity.thinker_id,
								pair_code: roomParam
							})
						});
						if(res.ok){
							const data = await res.json();
							if(data && data.room_id){
								currentRoomId = data.room_id;
								updateConnectStatus(`Verbunden mit Raum â€${data.room_id}â€œ. Signaling-Server verbunden.`);
								if(currentIdentity){
									initLiveChat(currentIdentity, data.room_id);
								}
							}
						}
					}catch{
						// Backend nicht verfÃ¼gbar - leise weiter
					}
				}
			}, 1000);
			
			return identity;
		}
	}
	
	// Normale Token-Verifizierung (wie vorher)
	const tokenObj = readManifestToken();
	if(!tokenObj){
		// Kein Token, aber Auto-Init trotzdem starten
		return await autoInitPresence();
	}
	const identity = await verifyTokenWithBackend(tokenObj);
	if(!identity){
		// Token-Verifizierung fehlgeschlagen, aber Auto-Init trotzdem starten
		return await autoInitPresence();
	}
	setVerifiedUI(true);
	startPresenceHeartbeat(identity);
	startMatchLoop(identity);
	updateConnectStatus('Verifiziert. Warte auf zweiten Teilnehmer oder gib ein gemeinsames Raum-Stichwort ein.');
	return identity;
}

// Live-Textkanal Ã¼ber WebSocket (Signaling-Server)
function initLiveChat(identity, roomId){
	const liveChat = document.getElementById('liveChat');
	const messagesEl = document.getElementById('liveChatMessages');
	const inputEl = document.getElementById('liveChatInput');
	const sendBtn = document.getElementById('liveChatSendBtn');

	if(!liveChat || !messagesEl || !inputEl || !sendBtn) return;

	// Vorherige Verbindung schlieÃŸen
	if(liveSocket && liveSocket.readyState === WebSocket.OPEN){
		try{ liveSocket.close(); }catch{}
	}

	liveChat.style.display = 'block';
	messagesEl.innerHTML = '';

	// Automatische Signaling-URL-Erkennung
	let signalUrl = (document.getElementById('signalUrl')?.value || '').trim();
	
	// Wenn keine URL eingegeben, automatisch Cloudflare Pages WebSocket verwenden
	if (!signalUrl) {
		// PrÃ¼fe ob auf Cloudflare Pages
		if (location.hostname.includes('pages.dev') || location.hostname.includes('workers.dev') || location.hostname.includes('cloudflare')) {
			// Cloudflare Pages WebSocket-Endpunkt
			const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
			signalUrl = `${protocol}//${location.host}/ws`;
		} else if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
			// Lokaler Signaling-Server (signal-server.js)
			signalUrl = 'ws://localhost:3100/ws';
		} else {
			// GitHub Pages oder andere: Versuche Cloudflare Pages WebSocket (falls verfÃ¼gbar)
			const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
			signalUrl = `${protocol}//${location.host}/ws`;
		}
	}
	
	// Speichere URL fÃ¼r spÃ¤ter
	if (document.getElementById('signalUrl')) {
		document.getElementById('signalUrl').value = signalUrl;
	}

	let ws;
	try{
		ws = new WebSocket(signalUrl);
		liveSocket = ws;
	}catch(err){
		appendChatSystem(messagesEl, 'Verbindung zum Signaling-Server fehlgeschlagen: '+(err?.message||String(err)));
		return;
	}

	ws.addEventListener('open', ()=>{
		appendChatSystem(messagesEl, `Verbindung zum Signaling-Server hergestellt. Raum â€${roomId}â€œ wird beigetreten â€¦`);
		ws.send(JSON.stringify({
			type: 'join',
			room_id: roomId,
			thinker_id: identity?.thinker_id || null
		}));
	});

	ws.addEventListener('message', (event)=>{
		let msg;
		try{
			msg = JSON.parse(event.data);
		}catch{
			return;
		}
		if(!msg || msg.room_id !== roomId) return;

		if(msg.type === 'system'){
			appendChatSystem(messagesEl, `System: Teilnehmer-Event (â€${msg.event||'event'}â€œ) im Raum.`);
			return;
		}
		if(msg.type === 'message'){
			const from = msg.from || 'Unbekannt';
			const text = msg.payload?.text || '';
			if(!text) return;
			appendChatMessage(messagesEl, from, text, msg.at);
			return;
		}
	});

	ws.addEventListener('close', ()=>{
		appendChatSystem(messagesEl, 'Verbindung zum Signaling-Server wurde geschlossen.');
	});
	ws.addEventListener('error', ()=>{
		appendChatSystem(messagesEl, 'Fehler auf der Signaling-Verbindung.');
	});

	function sendCurrent(){
		const text = (inputEl.value||'').trim();
		if(!text || !ws || ws.readyState !== WebSocket.OPEN) return;
		ws.send(JSON.stringify({
			type: 'message',
			room_id: roomId,
			thinker_id: identity?.thinker_id || null,
			payload: { text }
		}));
		appendChatMessage(messagesEl, 'Du', text, Date.now());
		inputEl.value = '';
	}

	sendBtn.onclick = sendCurrent;
	inputEl.onkeydown = (ev)=>{
		if(ev.key === 'Enter'){
			ev.preventDefault();
			sendCurrent();
		}
	};
}

function appendChatSystem(container, text){
	const div = document.createElement('div');
	div.className = 'live-chat-message';
	div.innerHTML = `<div class="meta">System</div><div>${e(text)}</div>`;
	container.appendChild(div);
	container.scrollTop = container.scrollHeight;
}

function appendChatMessage(container, from, text, at){
	const div = document.createElement('div');
	div.className = 'live-chat-message';
	const time = at ? new Date(at).toLocaleTimeString() : '';
	div.innerHTML = `<div class="meta">${e(from)} ${time? 'Â· '+e(time):''}</div><div>${e(text)}</div>`;
	container.appendChild(div);
	container.scrollTop = container.scrollHeight;
}
async function tryAutoVerify(){
	const params = parseHashParams();
	const p = {
		token: params[TOKEN_PARAM] || params.token || '',
		sig: params[SIG_PARAM] || params.sig || '',
		ts: params[TS_PARAM] || params.ts || '',
		uid: params.uid || null
	};
	if(!p.token || !p.ts) return false;
	// Freshness check (5 minutes)
	const skew = Math.abs(Date.now() - Number(p.ts));
	if(!Number.isFinite(skew) || skew > 5*60*1000) return false;
	// Fall 1: Signatur vorhanden â†’ klassischer HMAC-Check
	if(p.sig){
		const data = `${p.token}.${p.ts}`;
		const expect = await hmacSHA256Hex(p.token, data);
		if (expect === p.sig){
			setVerifiedUI(true);
			document.getElementById('token').value = p.token;
			markUserVerified({ uid: p.uid, mot: p.token, ts: p.ts, sig: p.sig });
			return true;
		}
		return false;
	}
	// Fall 2: Keine Signatur (Single-File/Offline-Download) â†’ Token + Zeitfenster reichen
	setVerifiedUI(true);
	document.getElementById('token').value = p.token;
	markUserVerified({ uid: p.uid, mot: p.token, ts: p.ts, sig: null });
	return true;
}
document.getElementById('verifyBtn').addEventListener('click', async ()=>{
	const t = document.getElementById('token').value.trim();
	if(!t) return alert('Token eingeben.');
	// Manual verify = enable features (shared secret possession)
	setVerifiedUI(true);
});

/* Feed rendering */
const feed = document.getElementById('feed');
function renderFeed(db){
	feed.innerHTML = '';
	const posts = db?.posts||[];
	if(!posts.length){
		const empty = document.createElement('div');
		empty.className = 'pad';
		empty.innerHTML = `<div class="muted">Keine BeitrÃ¤ge geladen.</div>`;
		feed.appendChild(empty);
		return;
	}
	posts.forEach(p=>{
		const el = document.createElement('article');
		el.className = 'entry';
		el.innerHTML = `
			<h3>${e(p.title||'Ohne Titel')}</h3>
			<div class="meta">${new Date(p.createdAt).toLocaleString()} ${p.initials? 'Â· '+e(p.initials):''} ${p.tags?.length? 'Â· Tags: '+p.tags.map(e).join(', '):''}</div>
			<div class="content" style="margin-top:8px;white-space:pre-wrap">${e(p.content)}</div>
			<div class="reactions">
				${REACTIONS.map(r=>{
					const c = p.reactions?.[r.key]||0;
					return c? `<span class="reaction">${r.label} (${c})</span>` : '';
				}).join('')}
			</div>
			${p.comments?.length? `<div style="margin-top:10px">${p.comments.map(c=>`<div class="comment"><strong>${e(c.by||'Anon')}</strong>: ${e(c.text)} <span class="meta" style="margin-left:6px">${new Date(c.at).toLocaleString()}</span></div>`).join('')}</div>`:''}
		`;
		feed.appendChild(el);
	});
}
function e(s){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}

/* Admin-Moderation Logik (lokal, ohne Backend) */
const verbergenBtn = document.getElementById('verbergenBtn');
const sichtbarBtn = document.getElementById('sichtbarBtn');
const statsBtn = document.getElementById('statsBtn');
const moderationScope = document.getElementById('moderationScope');
const moderationStatus = document.getElementById('moderationStatus');
if(verbergenBtn && moderationStatus && feed){
	verbergenBtn.addEventListener('click', ()=>{
		feed.classList.add('dimmed-feed');
		const scope = moderationScope?.value || 'local';
		moderationStatus.textContent = scope === 'session'
			? 'BeitrÃ¤ge im aktuellen View ausgeblendet (Sitzungsâ€‘Scope, nur UI).'
			: 'BeitrÃ¤ge im aktuellen Browser ausgeblendet (nur lokale Ansicht).';
	});
}
if(sichtbarBtn && moderationStatus && feed){
	sichtbarBtn.addEventListener('click', ()=>{
		feed.classList.remove('dimmed-feed');
		moderationStatus.textContent = 'BeitrÃ¤ge wieder vollstÃ¤ndig sichtbar (lokale Ansicht).';
	});
}
if(statsBtn && moderationStatus && feed){
	statsBtn.addEventListener('click', ()=>{
		const total = feed.querySelectorAll('.entry').length;
		moderationStatus.textContent = total
			? `Aktuelle BeitrÃ¤ge im Feed: ${total}.`
			: 'Aktuell sind keine BeitrÃ¤ge im Feed geladen.';
	});
}

// Psychologie / Telemetrie â€“ einfacher Client
let telemetryQueue = [];
let telemetryTimer = null;

function enqueueTelemetry(ev){
	try{
		telemetryQueue.push(ev);
		if(telemetryQueue.length >= 10){
			flushTelemetry();
		}else if(!telemetryTimer){
			telemetryTimer = setTimeout(flushTelemetry, 3000);
		}
	}catch{/* ignore */}
}

async function flushTelemetry(){
	const batch = telemetryQueue;
	if(!batch.length) return;
	telemetryQueue = [];
	if(telemetryTimer){
		clearTimeout(telemetryTimer);
		telemetryTimer = null;
	}
	try{
		await fetch(TELEMETRY_ENDPOINT, {
			method:'POST',
			headers:{'Content-Type':'application/json'},
			body: JSON.stringify(batch)
		});
	}catch{/* offline / optional */}
}

function installBasicTelemetry(){
	const { uid } = getUserContext();
	const base = {
		path: window.location.pathname + window.location.hash,
		actorUid: uid
	};
	enqueueTelemetry({ type:'page.view', ...base, meta:{ ts: Date.now() } });

	// Einfache "Rage Click" Erkennung
	let lastClickTime = 0;
	let lastTargetKey = '';
	let clickCount = 0;

	document.addEventListener('click', (ev)=>{
		const now = Date.now();
		const target = ev.target;
		const key = target && target.closest ? (target.closest('[data-telemetry-key]')?.getAttribute('data-telemetry-key') || target.tagName) : (target.tagName || 'UNKNOWN');

		if(now - lastClickTime < 800 && key === lastTargetKey){
			clickCount++;
		}else{
			clickCount = 1;
			lastTargetKey = key;
		}
		lastClickTime = now;

		enqueueTelemetry({ type:'ui.click', ...base, meta:{ key, x: ev.clientX, y: ev.clientY } });

		if(clickCount >= 4){
			enqueueTelemetry({ type:'ui.rage_click', ...base, meta:{ key, count: clickCount } });
			clickCount = 0;
		}
	}, {capture:true});

	// Form-AbbrÃ¼che kÃ¶nnen spÃ¤ter ergÃ¤nzt werden; Platzhalter als Hinweis
}

/* Payload viewer */
const payloadBox = document.getElementById('payloadBox');
document.getElementById('payloadBtn').addEventListener('click', ()=>{
	payloadBox.hidden = !payloadBox.hidden;
});

/* Import JSON file */
const jsonFile = document.getElementById('jsonFile');
jsonFile.addEventListener('change', async ()=>{
	const f = jsonFile.files?.[0]; if(!f) return;
	const text = await f.text();
	try{
		const data = JSON.parse(text);
		if(!data || !Array.isArray(data.posts)) throw new Error('UngÃ¼ltiges Format');
		renderFeed(data);
		payloadBox.hidden=false; payloadBox.textContent = JSON.stringify(data, null, 2);
	}catch(err){ alert('Import fehlgeschlagen: '+err.message); }
	jsonFile.value = '';
});

/* API fetch */
document.getElementById('fetchBtn').addEventListener('click', async ()=>{
	const url = document.getElementById('apiUrl').value.trim();
	if(!url) return alert('API URL angeben.');
	try{
		const res = await fetch(url, {headers:{'Accept':'application/json'}});
		const data = await res.json();
		renderFeed(data);
		payloadBox.hidden=false; payloadBox.textContent = JSON.stringify(data, null, 2);
	}catch(err){ alert('API Fehler: '+err.message); }
});
document.getElementById('clearBtn').addEventListener('click', ()=>{
	renderFeed({posts:[]}); payloadBox.hidden=true; payloadBox.textContent='';
});

/* Live-Funktionen initialisieren */
document.getElementById('initLiveBtn').addEventListener('click', ()=>{
	// PrÃ¼fe ob verifiziert
	if (!currentIdentity || !currentIdentity.thinker_id) {
		alert('Bitte zuerst verifizieren (Token aus Offline-Forum oder manuell eingeben).');
		return;
	}
	
	// PrÃ¼fe ob room_id vorhanden
	if (!currentRoomId) {
		// Erstelle room_id aus pair_code oder verwende manuell eingegebene
		const pairCode = getEffectivePairCode(currentIdentity);
		const manualRoomId = document.getElementById('roomId')?.value?.trim();
		
		if (manualRoomId) {
			currentRoomId = manualRoomId;
		} else if (pairCode) {
			// Generiere room_id aus pair_code
			currentRoomId = `room-${pairCode}`;
		} else {
			// Fallback: Verwende thinker_id als room_id
			currentRoomId = `room-${currentIdentity.thinker_id}`;
		}
	}
	
	// Initialisiere Live-Chat
	initLiveChat(currentIdentity, currentRoomId);
	
	// Zeige Live-Raum
	const liveRoom = document.getElementById('liveRoom');
	if (liveRoom) {
		liveRoom.style.display = 'block';
	}
	
	const liveRoomInfo = document.getElementById('liveRoomInfo');
	if (liveRoomInfo) {
		liveRoomInfo.textContent = `Live-Raum â€${currentRoomId}â€œ wurde initialisiert. Signaling-Server verbunden.`;
	}
});

/* Hidden Viewer, Medien & Datei-Transfer (UI-Stubs mit realen Aktionen) */
const loadHiddenBtn = document.getElementById('loadHiddenBtn');
const filePickInput = document.getElementById('filePick');
const filePickStatus = document.getElementById('filePickStatus');
const startMediaBtn = document.getElementById('startMediaBtn');
const stopMediaBtn = document.getElementById('stopMediaBtn');
const mediaStatus = document.getElementById('mediaStatus');
let mediaActive = false;

if(loadHiddenBtn){
	loadHiddenBtn.addEventListener('click', ()=>{
		const liveRoom = document.getElementById('liveRoom');
		if(liveRoom){
			liveRoom.style.display = 'block';
			const info = document.getElementById('liveRoomInfo');
			if(info){
				info.textContent = 'Hidden Viewer geÃ¶ffnet. Sobald ein echter Raum aktiv ist, werden hier Live-Inhalte eingeblendet.';
			}
		}
	});
}
if(filePickInput && filePickStatus){
	filePickInput.addEventListener('change', ()=>{
		const files = Array.from(filePickInput.files || []);
		if(!files.length){
			filePickStatus.textContent = 'Noch keine Dateien ausgewÃ¤hlt.';
			return;
		}
		filePickStatus.textContent = `${files.length} Datei(en) ausgewÃ¤hlt â€“ bereit fÃ¼r Upload zu einem R2-Endpunkt.`;
	});
}
function updateMediaStatus(){
	if(!mediaStatus) return;
	mediaStatus.textContent = mediaActive
		? 'Media-Demo aktiv (UI-Ebene). Ein echter Stream kann spÃ¤ter an diese Steuerung andocken.'
		: 'Media-/Streams sind noch inaktiv.';
}
if(startMediaBtn){
	startMediaBtn.addEventListener('click', ()=>{
		mediaActive = true;
		updateMediaStatus();
	});
}
if(stopMediaBtn){
	stopMediaBtn.addEventListener('click', ()=>{
		mediaActive = false;
		updateMediaStatus();
	});
}

/* API/Signaling Presets (Noâ€‘Code Helfer) */
const apiPresetSel = document.getElementById('apiPreset');
const apiUrlInput = document.getElementById('apiUrl');
if(apiPresetSel && apiUrlInput){
	apiPresetSel.addEventListener('change', ()=>{
		const v = apiPresetSel.value;
		if(v === 'supabase'){
			apiUrlInput.value = 'https://DEIN-PROJEKT.supabase.co/rest/v1/manifest';
		}else if(v === 'firebase'){
			apiUrlInput.value = 'https://us-central1-DEIN-PROJEKT.cloudfunctions.net/manifestList';
		}else if(v === 'custom'){
			apiUrlInput.value = '';
			apiUrlInput.placeholder = 'Eigene API-URL (z. B. https://deine-seite.tld/api/manifest/list)';
		}
	});
}

const signalPresetSel = document.getElementById('signalPreset');
const signalUrlInput = document.getElementById('signalUrl');
if(signalPresetSel && signalUrlInput){
	signalPresetSel.addEventListener('change', ()=>{
		const v = signalPresetSel.value;
		if(v === 'cloudflare'){
			// Automatisch Cloudflare Pages WebSocket verwenden
			const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
			signalUrlInput.value = `${protocol}//${location.host}/ws`;
		}else if(v === 'local'){
			// Lokaler Signaling-Server
			signalUrlInput.value = 'ws://localhost:3100/ws';
		}else if(v === 'twilio'){
			signalUrlInput.value = 'wss://DEIN-TWILIO-SIGNALING-ENDPUNKT';
		}else if(v === 'ably'){
			signalUrlInput.value = 'wss://realtime.ably.io?key=DEIN-ABLY-SCHLUESSEL';
		}else if(v === 'custom'){
			signalUrlInput.value = '';
			signalUrlInput.placeholder = 'Eigene WSS-URL (z. B. wss://signaling.deine-seite.tld)';
		}
	});
}

/* Token-URL Generator (Noâ€‘Code) */
const genBaseTokenInput = document.getElementById('genBaseToken');
const generateUrlBtn = document.getElementById('generateUrlBtn');
const generatedUrlBox = document.getElementById('generatedUrl');
if(generateUrlBtn && genBaseTokenInput && generatedUrlBox){
	generateUrlBtn.addEventListener('click', async ()=>{
		const base = genBaseTokenInput.value.trim();
		if(!base){
			alert('Bitte zuerst ein Basis-Token eingeben.');
			return;
		}
		try{
			const ts = Date.now().toString();
			const data = `${base}.${ts}`;
			const sig = await hmacSHA256Hex(base, data);
			const url = new URL(window.location.href);
			url.hash = `mot=${encodeURIComponent(base)}&ts=${encodeURIComponent(ts)}&sig=${encodeURIComponent(sig)}`;
			generatedUrlBox.value = url.toString();
		}catch(err){
			generatedUrlBox.value = 'Fehler beim Erzeugen der URL: ' + (err?.message || String(err));
		}
	});
}

/* Live-Raum JSON Builder (Noâ€‘Code) */
const roomTypeSel = document.getElementById('roomType');
const roomIdInput = document.getElementById('roomId');
const permRead = document.getElementById('permRead');
const permSend = document.getElementById('permSend');
const permSign = document.getElementById('permSign');
const permUpload = document.getElementById('permUpload');
const buildRoomJsonBtn = document.getElementById('buildRoomJsonBtn');
const roomJsonBox = document.getElementById('roomJsonBox');
if(buildRoomJsonBtn && roomTypeSel && roomIdInput && roomJsonBox){
	buildRoomJsonBtn.addEventListener('click', ()=>{
		const id = roomIdInput.value.trim();
		if(!id){
			alert('Bitte eine Raum-ID eintragen (z. B. post-123 oder wabe A-2).');
			return;
		}
		const room = {
			type: roomTypeSel.value || 'text',
			roomId: id,
			permissions: {
				read: !!permRead?.checked,
				send: !!permSend?.checked,
				sign: !!permSign?.checked,
				upload: !!permUpload?.checked
			}
		};
		roomJsonBox.textContent = JSON.stringify({ rooms:[room] }, null, 2);
	});
}

// Voucher & Termine UI
let voucherMode = 'customer'; // 'customer' | 'issuer'
let selectedVoucher = null;
const voucherListEl = document.getElementById('voucherList');
const slotListEl = document.getElementById('slotList');
const slotCalendarEl = document.getElementById('slotCalendar');
const voucherModeCustomerBtn = document.getElementById('voucherModeCustomer');
const voucherModeIssuerBtn = document.getElementById('voucherModeIssuer');
const voucherRefreshBtn = document.getElementById('btnVoucherRefresh');
const voucherTemplateButtons = document.querySelectorAll('[data-voucher-template]');
const eventsMembershipsOutput = document.getElementById('eventsMembershipsOutput');
const machinesTableBody = document.getElementById('machinesTableBody');
const eventsMembershipsTableBody = document.getElementById('eventsMembershipsTableBody');
const myBookingsList = document.getElementById('myBookingsList');

function setVoucherMode(mode){
	voucherMode = mode === 'issuer' ? 'issuer' : 'customer';
	if(voucherModeCustomerBtn && voucherModeIssuerBtn){
		if(voucherMode === 'customer'){
			voucherModeCustomerBtn.classList.add('btn');
			voucherModeCustomerBtn.classList.remove('alt');
			voucherModeIssuerBtn.classList.add('alt');
		}else{
			voucherModeIssuerBtn.classList.add('btn');
			voucherModeIssuerBtn.classList.remove('alt');
			voucherModeCustomerBtn.classList.add('alt');
		}
	}
	loadVouchers();
}

async function loadVouchers(){
	if(!voucherListEl) return;
	if(!VOUCHER_API_BASE) {
		voucherListEl.innerHTML = '<div class="muted">Voucher-API nicht verfÃ¼gbar. Bitte deploye auf Cloudflare Pages fÃ¼r volle FunktionalitÃ¤t.</div>';
		return;
	}
	const { uid } = getUserContext();
	let url = `${VOUCHER_API_BASE}/voucher/list`;
	const params = new URLSearchParams();
	if(voucherMode === 'issuer'){
		params.set('issuerUid', uid);
	}else{
		params.set('holderUid', uid);
	}
	url += `?${params.toString()}`;
	voucherListEl.innerHTML = '<div class="muted">Lade Vouchers â€¦</div>';
	slotListEl && (slotListEl.innerHTML = '');
	selectedVoucher = null;
	try{
		const res = await fetch(url);
		if(!res.ok) {
			voucherListEl.innerHTML = `<div class="muted">Fehler beim Laden: ${res.status} ${res.statusText}</div>`;
			return;
		}
		const data = await res.json();
		const items = data.items || [];
		if(!items.length){
			voucherListEl.innerHTML = '<div class="muted">Keine Vouchers gefunden.</div>';
			return;
		}
		voucherListEl.innerHTML = '';
		items.forEach(v => {
			const card = document.createElement('div');
			card.className = 'voucher-card';
			card.dataset.voucherId = v.voucherId;
			const statusClass = `status-${(v.status||'').toLowerCase()}`;
			const priceText = v.price && typeof v.price.amount === 'number'
				? `${(v.price.amount/100).toFixed(2)} ${(v.price.currency||'').toUpperCase()}`
				: '';
			card.innerHTML = `
				<div class="voucher-card-header">
					<div>
						<div style="font-size:13px;font-weight:600;">${e(v.title || v.serviceType || v.voucherId)}</div>
						<div class="voucher-meta">
							${v.serviceType ? e(v.serviceType) : ''}${priceText ? ' Â· '+e(priceText):''}
						</div>
					</div>
					<span class="voucher-badge ${statusClass}">${e(v.status || 'â€”')}</span>
				</div>
				<div class="voucher-meta">
					GÃ¼ltig: ${(v.validFrom||'').slice(0,10)} â€“ ${(v.validUntil||'').slice(0,10) || 'offen'}
				</div>
			`;
			card.addEventListener('click', ()=> {
				selectedVoucher = v;
				loadSlotsForVoucher(v);
			});
			voucherListEl.appendChild(card);
		});
	}catch(err){
		voucherListEl.innerHTML = `<div class="muted">Fehler beim Laden: ${e(err?.message||String(err))}</div>`;
	}
}

async function loadSlotsForVoucher(voucher){
	if(!slotListEl || !voucher || !voucher.voucherId) return;
	if(!VOUCHER_API_BASE) {
		slotListEl.innerHTML = '<div class="muted">Voucher-API nicht verfÃ¼gbar. Bitte deploye auf Cloudflare Pages fÃ¼r volle FunktionalitÃ¤t.</div>';
		if(slotCalendarEl) slotCalendarEl.innerHTML = '';
		return;
	}
	slotListEl.innerHTML = '<div class="muted">Lade verfÃ¼gbare Slots â€¦</div>';
	if(slotCalendarEl) slotCalendarEl.innerHTML = '';
	try{
		const res = await fetch(`${VOUCHER_API_BASE}/slots/available?voucherId=${encodeURIComponent(voucher.voucherId)}`);
		if(!res.ok) {
			slotListEl.innerHTML = `<div class="muted">Fehler beim Laden der Slots: ${res.status} ${res.statusText}</div>`;
			return;
		}
		const data = await res.json();
		const items = data.items || [];
		if(!items.length){
			slotListEl.innerHTML = '<div class="muted">Keine freien Slots verfÃ¼gbar.</div>';
			if(slotCalendarEl){
				slotCalendarEl.innerHTML = '<div class="slot-calendar-day"><span>â€“</span><span class="slot-calendar-badges">Keine Slots im Kalender.</span></div>';
			}
			return;
		}
		slotListEl.innerHTML = '';
		items.forEach(slot => {
			const div = document.createElement('div');
			div.className = 'slot-item';
			const start = new Date(slot.start);
			const end = new Date(slot.end);
			div.innerHTML = `
				<div>
					<div>${start.toLocaleDateString()} Â· ${start.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} â€“ ${end.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
					<div class="voucher-meta">${e(voucher.title || voucher.serviceType || voucher.voucherId)}</div>
				</div>
				<button class="btn alt" type="button">Buchen</button>
			`;
			const btn = div.querySelector('button');
			btn.addEventListener('click', ()=> bookSlot(voucher, slot));
			slotListEl.appendChild(div);
		});
		if(slotCalendarEl){
			renderSlotCalendar(items);
		}
	}catch(err){
		slotListEl.innerHTML = `<div class="muted">Fehler beim Laden der Slots: ${e(err?.message||String(err))}</div>`;
		if(slotCalendarEl){
			slotCalendarEl.innerHTML = '';
		}
	}
}

async function bookSlot(voucher, slot){
	if(!voucher || !slot) return;
	if(!VOUCHER_API_BASE) {
		alert('Voucher-API nicht verfÃ¼gbar. Bitte deploye auf Cloudflare Pages fÃ¼r volle FunktionalitÃ¤t.');
		return;
	}
	if(!confirm('Diesen Termin wirklich buchen?')) return;
	const { uid } = getUserContext();
	try{
		const res = await fetch(`${VOUCHER_API_BASE}/voucher/book`, {
			method:'POST',
			headers:{ 'Content-Type':'application/json', 'Accept':'application/json' },
			body: JSON.stringify({
				voucherId: voucher.voucherId,
				slotId: slot.slotId,
				holderUid: uid
			})
		});
		const data = await res.json();
		if(!res.ok || !data.ok){
			alert('Buchung fehlgeschlagen: ' + (data.error || res.statusText));
			return;
		}
		alert('Termin gebucht.\n\nDatum: ' + new Date(slot.start).toLocaleString());
		// Listen aktualisieren: Vouchers, Slots, vertikale Konsolen & persÃ¶nliche Buchungen
		loadVouchers();
		slotListEl && (slotListEl.innerHTML = '');
		loadVerticalConsoles();
		loadEventsMembershipsOverview();
		loadMyBookings();
	}catch(err){
		alert('Fehler bei der Buchung: ' + (err?.message || String(err)));
	}
}
const VOUCHER_TEMPLATES = {
	consulting: {
		serviceType: 'consulting.session',
		title: 'Beratung 60 Minuten',
		description: 'Individuelle Beratungsâ€‘Session (Video, Telefon oder Wabenraum).',
		durationMinutes: 60
	},
	therapy: {
		serviceType: 'therapy.session',
		title: 'Therapieâ€‘/Coachingâ€‘Session 50 Minuten',
		description: 'GeschÃ¼tzter Raum fÃ¼r Therapie oder Coaching, einmaliger Termin.',
		durationMinutes: 50
	},
	viewing: {
		serviceType: 'realestate.viewing',
		title: 'Hausâ€‘/Wohnungsbesichtigung',
		description: 'Besichtigungstermin fÃ¼r eine Immobilie mit definierter Zeitspanne.',
		durationMinutes: 45
	},
	machine: {
		serviceType: 'machine.timeslot',
		title: 'Maschinenzeit Slot',
		description: 'Nutzung einer Maschine oder eines Studios im Stundenâ€‘Takt.',
		durationMinutes: 60
	},
	membership: {
		serviceType: 'membership.access',
		title: 'Mitgliedschaftsâ€‘Voucher',
		description: 'Zugangsrecht zu einem geschlossenen Bereich (z.â€¯B. Community oder Club).',
		durationMinutes: 60*24
	}
};
const DEFAULT_VOUCHER_TEMPLATE_KEYS = ['consulting','therapy','viewing','machine','membership'];
async function issueVoucherTemplate(templateKey){
	const tpl = VOUCHER_TEMPLATES[templateKey];
	if(!tpl) return;
	if(!VOUCHER_API_BASE){
		alert('Voucherâ€‘API ist nicht konfiguriert.');
		return;
	}
	const { uid } = getUserContext();
	const now = new Date();
	const validFrom = now.toISOString();
	const validUntil = new Date(now.getTime() + 7*24*60*60*1000).toISOString();
	const body = {
		issuerUid: uid,
		...tpl,
		validFrom,
		validUntil,
		transferable: true,
		terms: { template: templateKey }
	};
	try{
		if (!VOUCHER_API_BASE) {
			alert('Voucherâ€‘API ist nicht verfÃ¼gbar. Bitte deploye auf Cloudflare Pages fÃ¼r volle FunktionalitÃ¤t.');
			return;
		}
		const res = await fetch(`${VOUCHER_API_BASE}/voucher/issue`, {
			method:'POST',
			headers:{ 'Content-Type':'application/json', 'Accept':'application/json' },
			body: JSON.stringify(body)
		});
		if (!res.ok) {
			const errorText = await res.text().catch(() => res.statusText);
			let errorMsg = `HTTP ${res.status}: ${errorText}`;
			try {
				const errorData = JSON.parse(errorText);
				if (errorData.error) errorMsg = errorData.error;
			} catch {}
			alert('Voucherâ€‘Vorlage konnte nicht ausgestellt werden: ' + errorMsg);
			// Fehler an Autofix melden
			if (window.enqueueError) {
				window.enqueueError(new Error(errorMsg), { type: 'voucher_issue_error', templateKey });
			}
			return;
		}
		const data = await res.json();
		if(!data || !data.ok){
			const errorMsg = data?.error || 'Unbekannter Fehler';
			alert('Voucherâ€‘Vorlage konnte nicht ausgestellt werden: ' + errorMsg);
			// Fehler an Autofix melden
			if (window.enqueueError) {
				window.enqueueError(new Error(errorMsg), { type: 'voucher_issue_error', templateKey });
			}
			return;
		}
		alert('Voucher aus Vorlage erstellt.');
		loadVouchers();
	}catch(err){
		const errorMsg = err?.message || String(err);
		alert('Fehler beim Ausstellen der Vorlage: ' + errorMsg);
		// Fehler an Autofix melden
		if (window.enqueueError) {
			window.enqueueError(err, { type: 'voucher_issue_error', templateKey });
		}
	}
}

async function ensureDefaultVouchersForIssuer(){
	// Autopilot: Wenn dieser Browser noch nie Standard-Voucher ausgestellt hat,
	// einmalig die wichtigsten Templates erzeugen, damit der User sofort echte Daten sieht.
	try{
		if(!VOUCHER_API_BASE) return;
		if(localStorage.getItem('mot_default_vouchers_issued_v1')) return;
		const { uid } = getUserContext();
		const res = await fetch(`${VOUCHER_API_BASE}/voucher/list?issuerUid=${encodeURIComponent(uid)}`, {
			headers:{ 'Accept':'application/json' }
		});
		const data = await res.json();
		const items = data.items || [];
		if(items.length > 0) return; // Es gibt schon Vouchers, nichts tun

		for(const key of DEFAULT_VOUCHER_TEMPLATE_KEYS){
			await issueVoucherTemplate(key);
		}
		localStorage.setItem('mot_default_vouchers_issued_v1', '1');
	}catch{
		// leise scheitern, Autopilot ist optional
	}
}
function renderSlotCalendar(slots){
	if(!slotCalendarEl) return;
	if(!slots || !slots.length){
		slotCalendarEl.innerHTML = '<div class="slot-calendar-day"><span>â€“</span><span class="slot-calendar-badges">Keine Slots im Kalender.</span></div>';
		return;
	}
	const byDay = new Map();
	for(const s of slots){
		const d = new Date(s.start);
		if(Number.isNaN(d.getTime())) continue;
		const key = d.toISOString().slice(0,10);
		if(!byDay.has(key)) byDay.set(key, []);
		byDay.get(key).push(s);
	}
	const days = Array.from(byDay.entries()).sort(([a],[b])=> a<b?-1:a>b?1:0);
	slotCalendarEl.innerHTML = '';
	for(const [day, list] of days){
		const dayEl = document.createElement('div');
		dayEl.className = 'slot-calendar-day';
		const left = document.createElement('span');
		left.textContent = new Date(day).toLocaleDateString();
		const right = document.createElement('span');
		right.className = 'slot-calendar-badges';
		list.slice(0,6).forEach(s=>{
			const t = new Date(s.start).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
			const b = document.createElement('span');
			b.textContent = t;
			b.style.border = '1px solid var(--border)';
			b.style.borderRadius = '999px';
			b.style.padding = '1px 6px';
			right.appendChild(b);
		});
		if(list.length>6){
			const more = document.createElement('span');
			more.textContent = `+${list.length-6}`;
			more.style.opacity = '0.7';
			right.appendChild(more);
		}
		dayEl.appendChild(left);
		dayEl.appendChild(right);
		slotCalendarEl.appendChild(dayEl);
	}
}
async function loadEventsMembershipsOverview(){
	if(!eventsMembershipsOutput || !VOUCHER_API_BASE) return;
	const { uid } = getUserContext();
	let text = '';
	try{
		const url = `${VOUCHER_API_BASE}/voucher/list?issuerUid=${encodeURIComponent(uid)}`;
		const res = await fetch(url, { headers:{ 'Accept':'application/json' } });
		const data = await res.json();
		const items = data.items || [];
		const relevantTypes = ['consulting.session','therapy.session','membership.access'];
		const relevant = items.filter(v => relevantTypes.includes(v.serviceType));
		if(!relevant.length){
			eventsMembershipsOutput.textContent = 'Keine Events oder Membershipâ€‘Vouchers gefunden (als Aussteller).';
			return;
		}
		const byType = {};
		for(const v of relevant){
			const t = v.serviceType || 'unknown';
			if(!byType[t]) byType[t] = [];
			byType[t].push(v);
		}
		text += 'Ãœbersicht pro Typ (als Aussteller):\n\n';
		for(const [type,list] of Object.entries(byType)){
			text += `â€¢ ${type} â€“ ${list.length} Voucher\n`;
		}
		text += '\nDetails:\n';
		for(const v of relevant){
			text += `- ${v.voucherId} | ${v.title || v.serviceType} | Status: ${v.status || 'â€”'} | GÃ¼ltig: ${(v.validFrom||'').slice(0,10)} â€“ ${(v.validUntil||'').slice(0,10) || 'offen'}\n`;
		}
		eventsMembershipsOutput.textContent = text;
	}catch(err){
		eventsMembershipsOutput.textContent = 'Fehler beim Laden der Ãœbersicht: ' + (err?.message || String(err));
	}
}

async function loadMyBookings(){
	if(!myBookingsList || !VOUCHER_API_BASE) return;
	const { uid } = getUserContext();
	myBookingsList.innerHTML = '<div class="muted">Lade deine Buchungen â€¦</div>';
	try{
		const res = await fetch(`${VOUCHER_API_BASE}/voucher/bookings?holderUid=${encodeURIComponent(uid)}`, {
			headers:{ 'Accept':'application/json' }
		});
		const data = await res.json();
		const items = data.items || [];
		if(!items.length){
			myBookingsList.innerHTML = '<div class="muted">Keine Buchungen gefunden.</div>';
			return;
		}
		myBookingsList.innerHTML = '';
		items.forEach(b=>{
			const row = document.createElement('div');
			row.className = 'slot-item';
			const start = b.slotStart ? new Date(b.slotStart) : null;
			const end = b.slotEnd ? new Date(b.slotEnd) : null;
			const range = (start && end)
				? `${start.toLocaleDateString()} Â· ${start.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})} â€“ ${end.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}`
				: 'â€”';
			row.innerHTML = `
				<div>
					<div>${e(range)}</div>
					<div class="voucher-meta">Voucher: ${e(b.voucherId || 'â€”')}</div>
				</div>
				<span class="voucher-badge status-${(b.status||'').toLowerCase()}">${e(b.status || 'â€”')}</span>
			`;
			myBookingsList.appendChild(row);
		});
	}catch(err){
		myBookingsList.innerHTML = '<div class="muted">Fehler beim Laden deiner Buchungen: '+e(err?.message||String(err))+'</div>';
	}
}

async function loadVerticalConsoles(){
	if(!machinesTableBody && !eventsMembershipsTableBody) return;
	if(!VOUCHER_API_BASE) {
		if(machinesTableBody) machinesTableBody.innerHTML = '<tr><td colspan="4" style="padding:4px 6px;color:var(--muted);">Voucher-API nicht verfÃ¼gbar.</td></tr>';
		if(eventsMembershipsTableBody) eventsMembershipsTableBody.innerHTML = '<tr><td colspan="4" style="padding:4px 6px;color:var(--muted);">Voucher-API nicht verfÃ¼gbar.</td></tr>';
		return;
	}
	const { uid } = getUserContext();
	try{
		const url = `${VOUCHER_API_BASE}/voucher/list?issuerUid=${encodeURIComponent(uid)}`;
		const res = await fetch(url, { headers:{ 'Accept':'application/json' } });
		const data = await res.json();
		const items = data.items || [];

		const machines = items.filter(v => v.serviceType === 'machine.timeslot');
		const eventTypes = ['consulting.session','therapy.session','realestate.viewing'];
		const events = items.filter(v => eventTypes.includes(v.serviceType));
		const memberships = items.filter(v => v.serviceType === 'membership.access');

		if(machinesTableBody){
			if(!machines.length){
				machinesTableBody.innerHTML = '<tr><td colspan="4" style="padding:4px 6px;color:var(--muted);">Noch keine Maschinenâ€‘Vouchers gefunden.</td></tr>';
			}else{
				machinesTableBody.innerHTML = machines.map(v=>{
					const priceText = v.price && typeof v.price.amount === 'number'
						? `${(v.price.amount/100).toFixed(2)} ${(v.price.currency||'').toUpperCase()}`
						: 'â€”';
					const period = `${(v.validFrom||'').slice(0,10)} â€“ ${(v.validUntil||'').slice(0,10) || 'offen'}`;
					// Standort wird aktuell aus terms.location oder terms.site gelesen (wenn vorhanden)
					const location = (v.terms && (v.terms.location || v.terms.site)) || 'â€”';
					return `<tr>
						<td style="padding:4px 6px;border-bottom:1px solid var(--border);">${e(v.title || 'Maschinenzeit')}</td>
						<td style="padding:4px 6px;border-bottom:1px solid var(--border);">${e(location)}</td>
						<td style="padding:4px 6px;border-bottom:1px solid var(--border);">${e(priceText)}</td>
						<td style="padding:4px 6px;border-bottom:1px solid var(--border);">${e(v.status || 'â€”')} (${e(period)})</td>
					</tr>`;
				}).join('');
			}
		}

		if(eventsMembershipsTableBody){
			const combined = [...events, ...memberships];
			if(!combined.length){
				eventsMembershipsTableBody.innerHTML = '<tr><td colspan="4" style="padding:4px 6px;color:var(--muted);">Noch keine Events/Memberships gefunden.</td></tr>';
			}else{
				eventsMembershipsTableBody.innerHTML = combined.map(v=>{
					const period = `${(v.validFrom||'').slice(0,10)} â€“ ${(v.validUntil||'').slice(0,10) || 'offen'}`;
					return `<tr>
						<td style="padding:4px 6px;border-bottom:1px solid var(--border);">${e(v.serviceType || 'â€”')}</td>
						<td style="padding:4px 6px;border-bottom:1px solid var(--border);">${e(v.title || '')}</td>
						<td style="padding:4px 6px;border-bottom:1px solid var(--border);">${e(v.status || 'â€”')}</td>
						<td style="padding:4px 6px;border-bottom:1px solid var(--border);">${e(period)}</td>
					</tr>`;
				}).join('');
			}
		}
	}catch(err){
		if(machinesTableBody){
			machinesTableBody.innerHTML = '<tr><td colspan="4" style="padding:4px 6px;color:var(--muted);">Fehler beim Laden der Maschinenâ€‘Konsole: '+e(err?.message||String(err))+'</td></tr>';
		}
		if(eventsMembershipsTableBody){
			eventsMembershipsTableBody.innerHTML = '<tr><td colspan="4" style="padding:4px 6px;color:var(--muted);">Fehler beim Laden der Events/Membershipsâ€‘Konsole: '+e(err?.message||String(err))+'</td></tr>';
		}
	}
}
// Hypotheken-Demo-Modul
const mortgageOutput = document.getElementById('mortgageOutput');
const btnLoadApplications = document.getElementById('btnLoadApplications');
const btnLoadOffers = document.getElementById('btnLoadOffers');
const btnNewApplication = document.getElementById('btnNewApplication');

async function loadMortgageApplications(){
	if(!mortgageOutput) return;
	const { uid } = getUserContext();
	try{
		const res = await fetch('/api/mortgage/application-list?role=borrower', {
			headers: {
				'Accept':'application/json',
				'X-MOT-User': uid
			}
		});
		const data = await res.json();
		mortgageOutput.textContent = JSON.stringify(data, null, 2);
	}catch(err){
		mortgageOutput.textContent = 'Fehler beim Laden der Anfragen: ' + (err?.message || String(err));
	}
}

async function loadMortgageOffers(){
	if(!mortgageOutput) return;
	const { uid } = getUserContext();
	try{
		const res = await fetch('/api/mortgage/offer-list?role=borrower', {
			headers: {
				'Accept':'application/json',
				'X-MOT-User': uid
			}
		});
		const data = await res.json();
		mortgageOutput.textContent = JSON.stringify(data, null, 2);
	}catch(err){
		mortgageOutput.textContent = 'Fehler beim Laden der Angebote: ' + (err?.message || String(err));
	}
}

async function createExampleMortgageApplication(){
	if(!mortgageOutput) return;
	const { uid } = getUserContext();
	const example = {
		propertyId: 'house-123',
		desiredLoan: { amount: 36000000, currency: 'EUR' },
		desiredDurationYears: 20,
		desiredRateType: 'fixed',
		maxInterestRate: 0.04,
		meta: {
			employmentStatus: 'employee',
			netIncomeMonthly: 380000,
			otherLoans: []
		}
	};
	try{
		const res = await fetch('/api/mortgage/application', {
			method:'POST',
			headers: {
				'Content-Type':'application/json',
				'Accept':'application/json',
				'X-MOT-User': uid
			},
			body: JSON.stringify(example)
		});
		const data = await res.json();
		mortgageOutput.textContent = JSON.stringify(data, null, 2);
	}catch(err){
		mortgageOutput.textContent = 'Fehler beim Erzeugen der Beispiel-Anfrage: ' + (err?.message || String(err));
	}
}

/* Anti copy for public viewers (soft) */
window.addEventListener('contextmenu', (e)=>{ if(document.body.classList.contains('public-view')) e.preventDefault(); }, {capture:true});
window.addEventListener('keydown', (e)=>{
	if(!document.body.classList.contains('public-view')) return;
	if((e.ctrlKey||e.metaKey)&&['c','x','s','p'].includes(e.key.toLowerCase())) e.preventDefault();
}, {capture:true});

/* Entry point */
(async function init(){
	// Public mode by default
	renderFeed({posts:[]});
	// Try auto verify via hash params
	await tryAutoVerify();
	// Auto-Connect: Token lesen, mit Backend verifizieren und PrÃ¤senz/Matching starten
	await autoConnectFromToken();
	// Phase 3: Konversations-Start-Templates - One-Click-Buttons einrichten
	setupQuickActionButtons();
	// Hypotheken-Demo-Buttons verdrahten
	if(btnLoadApplications) btnLoadApplications.addEventListener('click', loadMortgageApplications);
	if(btnLoadOffers) btnLoadOffers.addEventListener('click', loadMortgageOffers);
	if(btnNewApplication) btnNewApplication.addEventListener('click', createExampleMortgageApplication);
	// Voucher & Termine UI initialisieren
	if(voucherModeCustomerBtn) voucherModeCustomerBtn.addEventListener('click', ()=> setVoucherMode('customer'));
	if(voucherModeIssuerBtn) voucherModeIssuerBtn.addEventListener('click', ()=> setVoucherMode('issuer'));
	if(voucherRefreshBtn) voucherRefreshBtn.addEventListener('click', loadVouchers);
	// Standard: Kunde-Ansicht
	if(voucherListEl && slotListEl){
		setVoucherMode('customer');
	}
	if(voucherTemplateButtons && voucherTemplateButtons.length){
		voucherTemplateButtons.forEach(btn=>{
			btn.addEventListener('click', ()=>{
				const key = btn.getAttribute('data-voucher-template');
				issueVoucherTemplate(key);
			});
		});
	}
	await loadEventsMembershipsOverview();
	await loadVerticalConsoles();
	await loadMyBookings();
	// Autopilot: Standard-Voucher einmalig erzeugen, falls noch nichts existiert
	await ensureDefaultVouchersForIssuer();
	installBasicTelemetry();
})();
</script>
<script type="module">
import { loadProviders } from './router.js';

async function renderSuppliers() {
	const container = document.getElementById('suppliersList');
	if (!container) return;
	container.textContent = 'Lade Provider-Profile â€¦';
	try {
		const providers = await loadProviders();
		if (!providers.length) {
			container.textContent = 'Keine Provider-Profile konfiguriert.';
			return;
		}
		container.innerHTML = providers.map(p => {
			const tags = Array.isArray(p.tags) && p.tags.length ? ` Â· Tags: ${p.tags.join(', ')}` : '';
			const status = p.enabled === false ? 'deaktiviert' : 'aktiv';
			return `
				<div class="slot-item">
					<div>
						<div><strong>${p.label || p.id}</strong> <span class="voucher-meta">(${p.category || 'other'} Â· ${p.connector || 'n/a'})</span></div>
						<div class="voucher-meta">${p.description || ''}${tags}</div>
					</div>
					<span class="voucher-badge status-${status}">${status}</span>
				</div>
			`;
		}).join('');
	} catch (err) {
		container.textContent = 'Fehler beim Laden der Provider-Profile: ' + (err?.message || String(err));
	}
}

renderSuppliers().catch(() => {});
</script>
<script src="./ambient-media.js"></script>
<script type="module" src="./autofix-client.js"></script>
</body>
</html>

