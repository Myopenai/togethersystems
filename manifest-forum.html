<!doctype html>
<html lang="de">
<head>
  <meta name="ts-branding" content="T,.&T,,.&T,,,.TOGETHERSYSTEMS. INTERNATIONAL TTT T,.&T,,.T,,,.(C) (+31) - ( 613 803 782.) https://orcid.org/0009-0003-1328-2430">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Manifest of Thinkers â€“ Offline Forum</title>
<style>
/* Minimal, LinkedIn-adjacent UI cues without copying; all custom */
:root{
	--bg:#f4f2ee;
	--card:#ffffff;
	--ink:#1f1f1f;
	--muted:#6b7280;
	--primary:#0a66c2;
	--border:#e5e7eb;
	--ok:#0f9f6f;
	--warn:#e06a1a;
	--bad:#cb112d;
	--radius:12px;
}
*{box-sizing:border-box;}
body{
	margin:0;
	font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Ubuntu,Oxygen,Cantarell,"Helvetica Neue",Arial,sans-serif;
	background:var(--bg);
	color:var(--ink);
}
.wr{
	max-width:1060px;
	margin:0 auto;
	padding:16px;
}
header{
	display:flex;
	align-items:center;
	gap:12px;
	padding:16px;
	background:var(--card);
	border:1px solid var(--border);
	border-radius:var(--radius);
	position:sticky;top:0;z-index:10;
}
.logo{
	width:40px;height:40px;border-radius:50%;
	display:grid;place-items:center;
	color:#fff;background:var(--primary);
	font-weight:700;
}
h1{font-size:20px;margin:0;}
.subtitle{color:var(--muted);font-size:13px;}
.grid{
	display:grid;gap:16px;grid-template-columns:1fr 320px;
	margin-top:16px;
}
.card{
	background:var(--card);
	border:1px solid var(--border);
	border-radius:var(--radius);
}
.pad{padding:16px;}
label{display:block;font-size:13px;color:var(--muted);margin:8px 0 4px;}
input[type="text"], textarea, input[type="url"]{
	width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#fff;color:var(--ink);
}
textarea{min-height:120px;resize:vertical;}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.btn{
	background:var(--primary);color:#fff;border:none;border-radius:999px;padding:10px 14px;cursor:pointer;font-weight:600;
}
.btn.secondary{background:#eef2ff;color:#1e3a8a;border:1px solid #c7d2fe;}
.btn.gray{background:#f3f4f6;color:#111827;border:1px solid var(--border);}
.btn.ghost{background:transparent;color:var(--primary);border:1px solid var(--primary);}
.btn.warn{background:var(--warn);}
.btn.ok{background:var(--ok);}
.btn:disabled{opacity:.5;cursor:not-allowed;}
.hint{font-size:12px;color:var(--muted);}
.chip{
	display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#fafafa;
	font-size:12px;color:#374151;cursor:pointer;
}
.chip.active{border-color:var(--primary);box-shadow:0 0 0 2px #0a66c214}
.post{
	padding:16px;border-top:1px solid var(--border);
}
.post:first-child{border-top:none}
.post h3{margin:0 0 6px 0;font-size:18px}
.meta{font-size:12px;color:var(--muted);display:flex;gap:10px;align-items:center}
.reactions{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.reaction{
	border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:#fff;font-size:12px;cursor:pointer;
}
.reaction.active{border-color:var(--primary);color:var(--primary);background:#f0f7ff}
.comment-box{margin-top:12px}
.comment{
	margin-top:8px;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fafafa;font-size:14px;
}
.sec-title{font-size:14px;color:#374151;margin:0 0 8px;}
.list-empty{padding:24px;text-align:center;color:var(--muted)}
.kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;background:#f3f4f6;border:1px solid var(--border);border-bottom-width:2px;border-radius:6px;padding:2px 6px;font-size:12px;}
.notice{background:#fef3c7;border:1px solid #fde68a;color:#92400e;border-radius:10px;padding:10px 12px;font-size:13px}
footer{margin:24px 0;color:var(--muted);font-size:12px;text-align:center}

/* TogetherSystems Branding-Leiste */
.ts-brand-banner{
  background:linear-gradient(90deg,#020617,#0f172a 50%,#111827);
  color:#e5e7eb;
  padding:4px 12px;
  font-size:11px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:6px;
  border-bottom:1px solid rgba(148,163,184,.45);
}
.ts-brand-banner strong{font-weight:600;}
.ts-brand-sub{opacity:.78; display:block;}
.ts-brand-links a{
  color:#a5b4fc;
  text-decoration:none;
  font-size:11px;
  margin-left:8px;
  white-space:nowrap;
}
.ts-brand-links a:hover{text-decoration:underline;}

/* Skip to content - Accessibility */
.skip-to-content {
	position: absolute;
	top: -40px;
	left: 0;
	background: var(--accent, #10b981);
	color: #00100a;
	padding: 8px 16px;
	text-decoration: none;
	border-radius: 0 0 8px 0;
	z-index: 1000;
	font-weight: 600;
}
.skip-to-content:focus {
	top: 0;
}

</style>
</head>
<body>
	<a href="#main-content" class="skip-to-content">Overslaan en naar inhoud</a>
  <div class="ts-brand-banner">
    <div>
      <strong title="Initiator der neuen BÃ¶rsenfÃ¼hrung | Erster im Markt">T,.&T,,.&T,,,.TOGETHERSYSTEMS. INTERNATIONAL TTT T,.&T,,.T,,,.(C)</strong>
      <span class="ts-brand-sub">(+31) - ( 613 803 782.) https://orcid.org/0009-0003-1328-2430 | <a href="https://github.com/T-T-T-Sysytems-T-T-T-Systems-com-T-T/.github/blob/main/TGPA_Businessplan_DE.pdf" target="_blank" rel="noopener noreferrer" style="color:#a5b4fc;text-decoration:underline;">Businessplan</a> | T,.0031613803782.T,,.(C)R.D.TEL-DR.TEL | <span style="font-weight:500;color:#10b981;">Initiator der neuen BÃ¶rsenfÃ¼hrung â€“ Erster im Markt</span></span>
    </div>
    <div class="ts-brand-links">
      <a href="./index.html">Portal</a>
      <a href="./help-portal.html">Portal-Hilfe</a>
      <a href="./manifest-forum.html">Manifest</a>
      <a href="./help-manifest.html">Manifest-Hilfe</a>
      <a href="./manifest-portal.html">Online-Portal</a>
      <a href="./help-online-portal.html">Online-Portal-Hilfe</a>
      <a href="./honeycomb.html">WabenrÃ¤ume</a>
      <a href="./help-honeycomb.html">WabenrÃ¤ume-Hilfe</a>
      <a href="./legal-hub.html">Legal-Hub</a>
      <a href="./help-legal-hub.html">Legal-Hub-Hilfe</a>
      <a href="TELBANK/index.html" title="TPGA Telbank â€“ MetaMask Liquidity Console">ğŸ’° Telbank</a>
      <a href="business-admin.html" title="Business-Admin â€“ Vouchers & Buchungen">ğŸ“Š Business-Admin</a>
      <a href="admin-monitoring.html" title="Monitoring & Events">ğŸ“ˆ Monitoring</a>
      <a href="TsysytemsT/TsysytemsT.html" title="One Network Â· One Humanity Â· OPS / OSP">ğŸŒ One&nbsp;Network</a>
      <a href="https://www.gofundme.com/f/magnitudo?utm_campaign=unknown&amp;utm_medium=referral&amp;utm_source=widget" target="_blank" rel="noopener" title="Teilnahme an der Einsammlung (5â€“33.000&nbsp;â‚¬)">ğŸ’  UnterstÃ¼tzen</a>
      <a href="https://www.tinyurl.com/bugcompany" target="_blank" rel="noopener" title="GroÃŸunternehmen &amp; Stiftungen">ğŸ›ï¸ Big&nbsp;Support</a>
    </div>
  </div>

	<div class="wr" id="main-content">
		<header class="card">
			<div class="logo" aria-hidden="true">MoT</div>
			<div>
				<h1>Manifest of Thinkers â€“ Offline Forum</h1>
				<div class="subtitle">Thinking about everything Â· Offline ausfÃ¼llen, spÃ¤ter zentral verÃ¶ffentlichen</div>
			</div>
		</header>

		<!-- FORUM-NACHRICHT - Prominent -->
		<div class="card" style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(245, 158, 11, 0.2)); border: 4px solid #ef4444; margin-bottom: 16px; padding: 20px; animation: pulse 2s infinite;">
			<div style="text-align: center;">
				<h2 style="font-size: 1.8rem; background: linear-gradient(135deg, #ef4444, #f59e0b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 12px; font-weight: 800;">
					âš ï¸ WICHTIG: FORUM FÃœR FEHLER & PROBLEME âš ï¸
				</h2>
				<p style="font-size: 1.1rem; color: #1f1f1f; margin-bottom: 12px; font-weight: 600;">
					Wenn etwas nicht funktioniert, erstelle einen Thread im Forum!
				</p>
				<div style="background: rgba(255, 255, 255, 0.8); border: 2px solid #ef4444; border-radius: 12px; padding: 12px; margin: 12px 0;">
					<p style="font-size: 0.95rem; color: #e06a1a; margin-bottom: 8px; font-weight: 600;">
						ğŸ“ Erstelle einen eigenen Thread mit:
					</p>
					<ul style="text-align: left; color: #1f1f1f; font-size: 0.9rem; line-height: 1.6; max-width: 700px; margin: 0 auto;">
						<li>âœ… <strong>Deutlicher Beschreibung</strong> des Problems</li>
						<li>âœ… <strong>Medien</strong> (Screenshots, Videos, Logs)</li>
						<li>âœ… <strong>Text</strong> mit allen Details</li>
						<li>âœ… <strong>Schritt-fÃ¼r-Schritt</strong> Anleitung zum Reproduzieren</li>
					</ul>
				</div>
				<a href="https://tel1.boards.net/" target="_blank" rel="noopener" style="display: inline-block; background: linear-gradient(135deg, #ef4444, #f59e0b); color: #fff; padding: 1rem 2rem; border-radius: 12px; text-decoration: none; font-weight: 800; font-size: 1.1rem; box-shadow: 0 6px 20px rgba(239, 68, 68, 0.5); transition: all 0.3s; margin-top: 8px;">
					ğŸŒ FORUM Ã–FFNEN â†’
				</a>
				<div style="margin-top: 12px; padding: 8px; background: rgba(255, 255, 255, 0.9); border-radius: 8px;">
					<p style="color: #e06a1a; font-size: 0.85rem; font-weight: 600; margin: 0;">
						Branding: .[.https://tel1.boards.net/ METAMASK T,.RANSFERNETWORKS.T.,.TELBANK,T,,,.]
					</p>
				</div>
			</div>
		</div>
		<style>
			@keyframes pulse {
				0%, 100% { transform: scale(1); }
				50% { transform: scale(1.01); }
			}
		</style>

		<div class="grid">
			<main class="card">
				<div class="pad">
					<h2 style="margin:0 0 8px;">Beitrag erstellen</h2>
					<div class="notice" id="seedNotice" hidden>
						Einleitungs-Text aus LinkedIn wurde als Vorlage erkannt. Du kannst ihn unten Ã¼bernehmen oder anpassen.
					</div>
					<label for="title">Titel</label>
					<input id="title" type="text" placeholder="Manifest of Thinkers â€“ Thema">

					<label for="content">Inhalt</label>
					<textarea id="content" placeholder="Schreibe deine Gedanken, Analysen oder Berichte ..."></textarea>

					<label for="tags">Tags (kommagetrennt)</label>
					<input id="tags" type="text" placeholder="chaos, ordnung, universum">

					<label for="mediaUpload" style="margin-top:12px;">ğŸ“· Rich-Media: Bilder, Videos, Audio</label>
					<div style="margin-top:4px;">
						<label class="btn secondary" for="mediaUpload" style="display:inline-block;cursor:pointer">
							ğŸ“· Bilder/Videos/Audio hinzufÃ¼gen
						</label>
						<input id="mediaUpload" type="file" accept="image/*,video/*,audio/*" multiple style="display:none">
					</div>
					<div id="mediaPreview" style="margin-top:8px;display:flex;flex-wrap:wrap;gap:8px;"></div>
					<p class="hint" style="margin-top:4px;">UnterstÃ¼tzt: Bilder, Videos, Audio (unbegrenzt)</p>

					<div class="row" style="margin-top:12px">
						<div style="flex:1;min-width:200px">
							<label for="initials">Deine Initialen</label>
							<input id="initials" type="text" maxlength="4" placeholder="z. B. RDT">
						</div>
						<div style="flex:1;min-width:200px">
							<label for="identity">Logo (URL oder Upload)</label>
							<input id="identity" type="url" placeholder="https://.../logo.png oder Upload verwenden">
							<div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
								<label class="btn secondary" for="logoUpload" style="display:inline-block;cursor:pointer">
									ğŸ“· Logo hochladen
								</label>
								<button type="button" class="btn secondary" id="useEULogo" style="display:inline-block;cursor:pointer" title="EU-Logo verwenden (Made in Europe)">
									ğŸ‡ªğŸ‡º EU-Logo verwenden
								</button>
							</div>
							<input id="logoUpload" type="file" accept="image/*" style="display:none">
							<div id="logoPreview" style="margin-top:8px;display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
								<a id="logoPreviewLink" href="" target="_blank" rel="noopener noreferrer" style="display:none;">
									<img id="logoPreviewImg" src="" alt="Logo-Vorschau" style="max-width:120px;max-height:60px;border-radius:8px;border:1px solid var(--border);cursor:pointer;">
								</a>
								<button type="button" class="btn ghost" id="removeLogo" style="display:none;font-size:12px;">Entfernen</button>
							</div>
						</div>
					</div>
					<div class="row" style="margin-top:12px">
						<button class="btn" id="addPostBtn">Beitrag speichern</button>
						<button class="btn gray" id="clearComposerBtn">Eingabe leeren</button>
						<button class="btn secondary" id="aiAssistBtn" title="KI-Assistent: Titel, Tags und Zusammenfassung vorschlagen">ğŸ¤– KI-Assistenz</button>
					</div>
				</div>

				<div class="post-list" id="postList"></div>
				<div class="list-empty" id="emptyList">Noch keine BeitrÃ¤ge gespeichert.</div>
			</main>

			<aside class="card">
				<div class="pad">
					<h3 class="sec-title">Reaktionen (Auswahl)</h3>
					<div class="row" id="reactionsPalette">
						<span class="chip" data-reaction="like">GefÃ¤llt mir</span>
						<span class="chip" data-reaction="celebrate">Gefeliciteerd</span>
						<span class="chip" data-reaction="support">StÃ¼tzen</span>
						<span class="chip" data-reaction="love">Gewaltig</span>
						<span class="chip" data-reaction="insightful">Verheldernd</span>
						<span class="chip" data-reaction="curious">Interessant</span>
						<span class="chip" data-reaction="entertainment">Rappig</span>
					</div>
				</div>
				<div class="pad" style="border-top:1px solid var(--border)">
					<h3 class="sec-title">Daten</h3>
					<div class="row">
						<button class="btn ok" id="exportJsonBtn">Export JSON</button>
						<button class="btn ok" id="exportCompleteBtn" title="VollstÃ¤ndiger Export (Alle Daten)">Export Alles</button>
						<label class="btn gray" for="importJsonInput" style="cursor:pointer">Import JSON</label>
						<input id="importJsonInput" type="file" accept="application/json" style="display:none">
					</div>
					<p class="hint">Exportiere/Importiere deine lokale Forum-Datenbank. "Export Alles" exportiert alle Daten inkl. Einstellungen.</p>
					<div class="row" style="margin-top:8px">
						<button class="btn gray" id="downloadSelfBtn" type="button">Offline-Kopie speichern</button>
					</div>
					<p class="hint">Speichert diese Offline-Datei selbst als Kopie (z.&nbsp;B. zur Weitergabe oder eigenes Backup).</p>
				</div>
				<div class="pad" style="border-top:1px solid var(--border)">
					<h3 class="sec-title">Statische Webseite erzeugen</h3>
					<div class="row">
						<button class="btn" id="exportSiteBtn">Download HTML</button>
					</div>
					<p class="hint">Erstellt eine fertige, lesbare HTML-Seite (â€manifest-site.htmlâ€œ) mit allen EintrÃ¤gen â€“ bereit fÃ¼r Upload auf deine zentrale Webseite.</p>
				</div>
				<div class="pad" style="border-top:1px solid var(--border)">
					<h3 class="sec-title">VerÃ¶ffentlichen (API)</h3>
					<label for="apiUrl">API-Endpoint (POST)</label>
					<input id="apiUrl" type="url" placeholder="https://deine-seite.tld/api/manifest/submit">
					<label for="apiKey">API-SchlÃ¼ssel (optional)</label>
					<input id="apiKey" type="text" placeholder="Bearer ... oder leer lassen">
					<div class="row" style="margin-top:8px">
						<button class="btn" id="publishBtn">BeitrÃ¤ge senden</button>
						<button class="btn ghost" id="testPayloadBtn" title="Zeigt die JSON-Nutzlast an">Payload anzeigen</button>
					</div>
					<p class="hint">Dies sendet deine lokal gespeicherten BeitrÃ¤ge gesammelt an den angegebenen Endpoint. Es erfolgt keine automatische VerÃ¶ffentlichung ohne deine Aktion.</p>
					<pre class="kbd" id="publishStatus" style="margin-top:8px;white-space:pre-wrap;max-height:180px;overflow:auto"></pre>
				</div>
				<div class="pad" style="border-top:1px solid var(--border)">
					<h3 class="sec-title">Hyperkommunikation â€“ Audio/Video/Code/Formula/Daten</h3>
					<p class="hint">
						Dieses Offlineâ€‘Forum ist der Textâ€‘Anker innerhalb eines grÃ¶ÃŸeren Hyperkommunikationsâ€‘Systems:
						Audioâ€‘/Videoâ€‘RÃ¤ume, geteilte Codeâ€‘ und Formelâ€‘Snippets sowie strukturierte Daten kÃ¶nnen
						spÃ¤ter an dieselben BeitrÃ¤ge andocken. Die Offlineâ€‘Datei bleibt dabei immer die
						ursprÃ¼ngliche Referenz.
					</p>
					<div class="row" style="margin-top:6px;font-size:12px;">
						<label class="chip">
							<input id="chAudio" type="checkbox" style="margin-right:4px;"> Audioâ€‘KanÃ¤le aktivieren
						</label>
						<label class="chip">
							<input id="chVideo" type="checkbox" style="margin-right:4px;"> Videoâ€‘KanÃ¤le aktivieren
						</label>
						<label class="chip">
							<input id="chCode" type="checkbox" style="margin-right:4px;"> Code/Formulaâ€‘Ansicht
						</label>
					</div>
					<p class="hint" style="margin-top:4px;">
						Diese Schalter sind Vorbereitung fÃ¼r spÃ¤tere Audioâ€‘/Videoâ€‘/Codeâ€‘Module und kÃ¶nnen bereits
						im Offlineâ€‘Modus ausprobiert werden.
					</p>
				</div>
				<div class="pad" style="border-top:1px solid var(--border)">
					<h3 class="sec-title">Mesh-Networking &amp; P2P-Sync</h3>
					<p class="hint">
						Im Vollausbau kÃ¶nnen mehrere Manifestâ€‘Dateien Ã¼ber ein Meshâ€‘Netzwerk miteinander synchronisiert
						werden (P2Pâ€‘Sync). Diese Version zeigt bereits die Steuerungsâ€‘Elemente, die spÃ¤ter an einen
						signierenden Syncâ€‘Dienst angebunden werden kÃ¶nnen.
					</p>
					<div class="row" style="margin-top:6px">
						<button class="btn gray" id="meshPeersBtn" type="button">Peers suchen</button>
						<button class="btn gray" id="meshSyncBtn" type="button">P2P-Sync anstoÃŸen</button>
					</div>
					<p class="hint" id="meshStatus" style="margin-top:4px;">Noch kein Mesh aktiv â€“ lokale Einzelansicht.</p>
				</div>
				<div class="pad" style="border-top:1px solid var(--border)">
					<h3 class="sec-title">UnterstÃ¼tze Manifest of Thinkers</h3>
					<p class="hint">
						Diese Offlineâ€‘Datei ist nicht â€von selbstâ€œ entstanden â€“ hinter ihr stehen viel Zeit, Wissen und Emotion.
						Wenn du dauerhaft mitdenkst und mitschreibst, kannst du freiwillig einen Beitrag leisten:
						ab <strong>5&nbsp;â‚¬</strong> bis zu einem Kampagnenâ€‘Ziel von <strong>33.000&nbsp;â‚¬</strong>.
					</p>
					<div class="row" style="margin-top:6px">
						<a class="btn" href="https://www.gofundme.com/f/magnitudo?utm_campaign=unknown&amp;utm_medium=referral&amp;utm_source=widget" target="_blank" rel="noopener">
							ğŸ’  Beitrag 5â€“33.000&nbsp;â‚¬
						</a>
						<a class="btn gray" href="https://www.tinyurl.com/bugcompany" target="_blank" rel="noopener">
							ğŸ›ï¸ GroÃŸunternehmer / MKB
						</a>
					</div>
					<p class="hint" style="margin-top:6px">
						Die Kommunikation bleibt frei, ohne Login und ohne Pflicht. Deine Beteiligung hilft, die Plattform zu erhalten
						und weitere â€Pfeilerâ€œ fÃ¼r die Gesellschaft aufzubauen.
					</p>
				</div>
			</aside>
		</div>

		<footer>
			Manifest of Thinkers â€“ Offline Forum Â· Raymond Demitrio Tel Â· <a href="https://www.linkedin.com/posts/raymond-demitrio-tel-b5393a67_je-gedachten-zouden-als-volgt-kunnen-worden-activity-7392911153858879488-MJp_?utm_source=share&utm_medium=member_desktop&rcm=ACoAAA4y2O8BPiJ7FgkzixlP6EUYGlnKzpAK6vs" target="_blank" rel="noopener">LinkedIn-Quelle</a>
		</footer>
	</div>

<script>
// Eingebetteter Minimal-Core fÃ¼r Single-File-Betrieb (kein externes mot-core.js nÃ¶tig)
const MOT_STORAGE_KEYS = {
	USER_ID: 'mot_user_id_v1'
};
function generateRandomId(length = 22){
	const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
	let result = '';
	const array = new Uint32Array(length);
	if (window.crypto && window.crypto.getRandomValues) {
		window.crypto.getRandomValues(array);
		for (let i = 0; i < length; i++) {
			result += chars[array[i] % chars.length];
		}
	} else {
		for (let i = 0; i < length; i++) {
			result += chars[Math.floor(Math.random() * chars.length)];
		}
	}
	return result;
}
function getOrCreateUserId(){
	try{
		let uid = localStorage.getItem(MOT_STORAGE_KEYS.USER_ID);
		if(!uid){
			uid = generateRandomId();
			localStorage.setItem(MOT_STORAGE_KEYS.USER_ID, uid);
		}
		return uid;
	}catch{
		// Fallback falls localStorage nicht verfÃ¼gbar ist
		return generateRandomId();
	}
}

/* Storage */
const DB_KEY = 'mot_forum_v1';
// Shared access token: included in distributed offline file; same for all official copies.
const MOT_ACCESS_TOKEN = 'mot-shared-token-v1';
function motNow(){ return Date.now(); }
function loadDB(){
	try{ return (function() { try { return JSON.parse(localStorage.getItem(DB_KEY); } catch(e) { console.error('JSON parse error:', e); return null; } })() || '{"posts":[]}'); }
	catch(e){ return {posts:[]}; }
}
function saveDB(db){ localStorage.setItem(DB_KEY, JSON.stringify(db)); }

/* Elements */
const postList = document.getElementById('postList');
const emptyList = document.getElementById('emptyList');
const seedNotice = document.getElementById('seedNotice');
const titleEl = document.getElementById('title');
const contentEl = document.getElementById('content');
const tagsEl = document.getElementById('tags');
const initialsEl = document.getElementById('initials');
const identityEl = document.getElementById('identity');
const addPostBtn = document.getElementById('addPostBtn');
const clearComposerBtn = document.getElementById('clearComposerBtn');
const reactionsPalette = document.getElementById('reactionsPalette');
const exportJsonBtn = document.getElementById('exportJsonBtn');
const exportCompleteBtn = document.getElementById('exportCompleteBtn');
const importJsonInput = document.getElementById('importJsonInput');
const downloadSelfBtn = document.getElementById('downloadSelfBtn');
const exportSiteBtn = document.getElementById('exportSiteBtn');
const apiUrlEl = document.getElementById('apiUrl');
const apiKeyEl = document.getElementById('apiKey');
const publishBtn = document.getElementById('publishBtn');
const testPayloadBtn = document.getElementById('testPayloadBtn');
const publishStatus = document.getElementById('publishStatus');
// Add portal open button in aside (dynamic inject to avoid layout churn)
(function injectPortalOpen(){
	const aside = document.querySelector('aside.card .pad');
	if(!aside) return;
	const row = document.createElement('div');
	row.style.borderTop = '1px solid var(--border)';
	row.className = 'pad';
	row.innerHTML = `
		<h3 class="sec-title">Portal</h3>
		<div class="row">
			<button class="btn" id="openPortalBtn">Portal Ã¶ffnen (verifiziert)</button>
		</div>
		<p class="hint">Ã–ffnet die Online-Seite und Ã¼bergibt einen zeitgebundenen Nachweis deiner offiziellen Offline-Datei.</p>
	`;
	aside.parentElement.appendChild(row);
})();

/* Reactions master list mapped to requested labels */
const REACTIONS = [
	{key:'like', label:'GefÃ¤llt mir'},
	{key:'celebrate', label:'Gefeliciteerd'},
	{key:'support', label:'StÃ¼tzen'},
	{key:'love', label:'Gewaltig'},
	{key:'insightful', label:'Verheldernd'},
	{key:'curious', label:'Interessant'},
	{key:'entertainment', label:'Rappig'}
];

/* Seed from LinkedIn text if empty content */
const LINKEDIN_SEED = `Je gedachten zouden als volgt kunnen worden samengevat: Voordat het universum ontstond, was er geen "nichts", maar pure chaos â€“ energie, wanorde, potentieel... (Aus LinkedIn Post zusammengefasst)`;
function trySeedComposer(){
	if(!contentEl.value.trim()){
		contentEl.value = LINKEDIN_SEED;
		seedNotice.hidden = false;
	}
}

/* Render */
function render(){
	const db = loadDB();
	postList.innerHTML = '';
	if(!db.posts.length){
		emptyList.style.display = 'block';
		return;
	}
	emptyList.style.display = 'none';
	db.posts.forEach((p, idx)=>{
		const el = document.createElement('div');
		el.className = 'post';
		el.innerHTML = `
			<div style="display:flex;align-items:flex-start;gap:12px;margin-bottom:8px">
				${(p.logoUrl || p.identity) && ((p.logoUrl || p.identity).startsWith('data:image') || (p.logoUrl || p.identity).startsWith('./assets/') || (p.logoUrl || p.identity).startsWith('http')) 
					? `<a href="${escapeHtml(p.logoUrl || p.identity)}" target="_blank" rel="noopener noreferrer" style="display:inline-block;line-height:0;flex-shrink:0;"><img src="${escapeHtml(p.logoUrl || p.identity)}" alt="Logo" style="width:48px;height:48px;border-radius:8px;object-fit:cover;border:1px solid var(--border);cursor:pointer;"></a>`
					: ''}
				<div style="flex:1">
					<h3>${escapeHtml(p.title || 'Ohne Titel')}</h3>
					<div class="meta">
						<span>${new Date(p.createdAt).toLocaleString()}</span>
						${p.initials ? `<span>Â· ${escapeHtml(p.initials)}</span>`:''}
						${p.tags?.length ? `<span>Â· Tags: ${p.tags.map(escapeHtml).join(', ')}</span>`:''}
					</div>
				</div>
			</div>
			<div style="margin-top:8px;white-space:pre-wrap">${escapeHtml(p.content)}</div>
			${p.media && p.media.length ? `<div style="margin-top:8px;">${renderMediaInPost(p)}</div>` : ''}
			<div class="reactions" data-idx="${idx}">
				${REACTIONS.map(r=>{
					const count = p.reactions?.[r.key]||0;
					return `<button class="reaction ${count>0?'active':''}" data-reaction="${r.key}" title="${r.label}">${r.label}${count?` (${count})`:''}</button>`;
				}).join('')}
			</div>
			<div class="comment-box">
				<div class="row">
					<input type="text" placeholder="Kommentar hinzufÃ¼gen ..." data-comment-input="${idx}">
					<button class="btn gray" data-add-comment="${idx}">Kommentieren</button>
					<button class="btn ghost" data-delete-post="${idx}" title="Beitrag lÃ¶schen">LÃ¶schen</button>
				</div>
				<div class="comments" style="margin-top:8px">
					${(p.comments||[]).map(c=>`<div class="comment"><strong>${escapeHtml(c.by||'Anon')}</strong>: ${escapeHtml(c.text)} <span class="meta" style="display:inline-block;margin-left:8px">${new Date(c.at).toLocaleString()}</span></div>`).join('')}
				</div>
			</div>
		`;
		postList.appendChild(el);
	});
}

/* Helpers */
function escapeHtml(s){
	return String(s).replace(/[&<>"']/g, m=>({
		'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
	}[m]));
}

// Rich-Media Rendering
function renderMediaInPost(post) {
	if (!post.media || !post.media.length) return '';
	return post.media.map(m => {
		if (m.type === 'image') {
			return `<img src="${escapeHtml(m.url)}" alt="${escapeHtml(m.name || '')}" style="max-width:100%;border-radius:8px;margin:4px 0;cursor:pointer;border:1px solid var(--border);" onclick="window.open('${escapeHtml(m.url)}', '_blank')">`;
		} else if (m.type === 'video') {
			return `<video src="${escapeHtml(m.url)}" controls style="max-width:100%;border-radius:8px;margin:4px 0;border:1px solid var(--border);"></video>`;
		} else if (m.type === 'audio') {
			return `<div style="border:1px solid var(--border);border-radius:8px;padding:8px;margin:4px 0;"><audio src="${escapeHtml(m.url)}" controls style="width:100%;"></audio><div style="font-size:12px;color:var(--muted);margin-top:4px;">${escapeHtml(m.name || 'Audio')}</div></div>`;
		}
		return '';
	}).join('');
}
function parseTags(s){
	return s.split(',').map(x=>x.trim()).filter(Boolean);
}
function download(filename, text){
	const a = document.createElement('a');
	a.href = URL.createObjectURL(new Blob([text], {type:'text/plain;charset=utf-8'}));
	a.download = filename;
	document.body.appendChild(a); a.click(); a.remove();
	setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
}

/* Events: composer */
addPostBtn.addEventListener('click', async ()=>{
	const title = titleEl.value.trim();
	const content = contentEl.value.trim();
	if(!content){ alert('Bitte Inhalt eingeben.'); return; }
	const tags = parseTags(tagsEl.value||'');
	const initials = initialsEl.value.trim();
	const identity = identityEl.value.trim();
	const db = loadDB();
	const logoUrl = identityEl.value.trim() || null;
	
	// Rich-Media sammeln
	let media = uploadedMedia || [];
	try {
		const mediaStorage = document.getElementById('uploadedMediaStorage');
		if (mediaStorage && mediaStorage.dataset.media) {
			const parsed = JSON.parse(mediaStorage.dataset.media);
			if (parsed && parsed.length) media = parsed;
		}
	} catch(e) { console.error('Media parse error:', e); }
	
	const postData = {
		id: crypto.randomUUID(),
		title, content, tags, initials, identity: identityEl.value.trim() || null,
		logoUrl: logoUrl,
		media: media.length > 0 ? media.map(m => ({ url: m.dataUrl, type: m.type, name: m.name, mimeType: m.mimeType })) : undefined,
		reactions: {},
		comments: [],
		createdAt: Date.now()
	};
	
	db.posts.unshift(postData);
	saveDB(db);
	
	// Media-Input zurÃ¼cksetzen
	const mediaStorage = document.getElementById('uploadedMediaStorage');
	if (mediaStorage) mediaStorage.dataset.media = '';
	const mediaPreview = document.getElementById('mediaPreview');
	if (mediaPreview) mediaPreview.innerHTML = '';
	const mediaInput = document.getElementById('mediaUpload');
	if (mediaInput) mediaInput.value = '';
	
	render();
});
clearComposerBtn.addEventListener('click', ()=>{
	titleEl.value='';contentEl.value='';tagsEl.value='';initialsEl.value='';
	identityEl.value='';
	const preview = document.getElementById('logoPreview');
	if(preview) preview.style.display = 'none';
	const mediaPreview = document.getElementById('mediaPreview');
	if(mediaPreview) mediaPreview.innerHTML = '';
	const mediaInput = document.getElementById('mediaUpload');
	if(mediaInput) mediaInput.value = '';
	const mediaStorage = document.getElementById('uploadedMediaStorage');
	if(mediaStorage) mediaStorage.dataset.media = '';
});

/* Rich-Media Upload */
const mediaUploadEl = document.getElementById('mediaUpload');
const mediaPreviewEl = document.getElementById('mediaPreview');
let uploadedMedia = [];

if(mediaUploadEl){
	mediaUploadEl.addEventListener('change', async (e)=>{
		const files = Array.from(e.target.files || []);
		if(!files.length) return;
		
		if(!mediaPreviewEl) return;
		
		uploadedMedia = [];
		
		for (const file of files) {
			// KEINE GRENZEN - Unbegrenzter Upload
			const fileType = file.type.split('/')[0];
			
			// Optional: Warnung bei sehr groÃŸen Dateien (nur Info, kein Block)
			if (file.size > 100 * 1024 * 1024) { // > 100MB
				console.warn(`GroÃŸe Datei: ${file.name} (${Math.round(file.size / 1024 / 1024)}MB) - Upload kann lÃ¤nger dauern.`);
			}
			
			const reader = new FileReader();
			reader.onload = (ev) => {
				const dataUrl = ev.target.result;
				uploadedMedia.push({ dataUrl, type: fileType, name: file.name, size: file.size, mimeType: file.type });
				
				const previewItem = document.createElement('div');
				previewItem.style.cssText = 'position:relative;display:inline-block;margin:4px;border:1px solid var(--border);border-radius:8px;overflow:hidden;';
				
				if (fileType === 'image') {
					const img = document.createElement('img');
					img.src = dataUrl;
					img.style.cssText = 'max-width:200px;max-height:200px;display:block;';
					previewItem.appendChild(img);
				} else if (fileType === 'video') {
					const video = document.createElement('video');
					video.src = dataUrl;
					video.controls = true;
					video.style.cssText = 'max-width:200px;max-height:200px;display:block;';
					previewItem.appendChild(video);
				} else if (fileType === 'audio') {
					const audio = document.createElement('audio');
					audio.src = dataUrl;
					audio.controls = true;
					audio.style.cssText = 'width:200px;display:block;';
					previewItem.appendChild(audio);
					const label = document.createElement('div');
					label.textContent = file.name;
					label.style.cssText = 'padding:4px;font-size:12px;';
					previewItem.appendChild(label);
				}
				
				const removeBtn = document.createElement('button');
				removeBtn.textContent = 'Ã—';
				removeBtn.style.cssText = 'position:absolute;top:4px;right:4px;background:rgba(0,0,0,0.7);color:white;border:none;border-radius:50%;width:24px;height:24px;cursor:pointer;';
				removeBtn.onclick = () => {
					previewItem.remove();
					const index = uploadedMedia.findIndex(m => m.dataUrl === dataUrl);
					if (index > -1) uploadedMedia.splice(index, 1);
					updateMediaStorage();
				};
				previewItem.appendChild(removeBtn);
				
				mediaPreviewEl.appendChild(previewItem);
				updateMediaStorage();
			};
			reader.readAsDataURL(file);
		}
	});
}

function updateMediaStorage() {
	let storage = document.getElementById('uploadedMediaStorage');
	if (!storage) {
		storage = document.createElement('input');
		storage.type = 'hidden';
		storage.id = 'uploadedMediaStorage';
		document.body.appendChild(storage);
	}
	storage.dataset.media = JSON.stringify(uploadedMedia);
}

/* Logo Upload */
const logoUploadEl = document.getElementById('logoUpload');
const logoPreviewEl = document.getElementById('logoPreview');
const logoPreviewImgEl = document.getElementById('logoPreviewImg');
const removeLogoEl = document.getElementById('removeLogo');

if(logoUploadEl){
	logoUploadEl.addEventListener('change', async (e)=>{
		const file = e.target.files?.[0];
		if(!file) return;
		
		// Validate file type
		if(!file.type.startsWith('image/')){
			alert('Bitte wÃ¤hle eine Bilddatei aus.');
			e.target.value = '';
			return;
		}
		
		// Validate file size (max 2MB)
		if(file.size > 2 * 1024 * 1024){
			alert('Bild zu groÃŸ. Maximal 2MB erlaubt.');
			e.target.value = '';
			return;
		}
		
		// Convert to Data URL
		try{
			const reader = new FileReader();
			reader.onload = (ev) => {
				const dataUrl = ev.target.result;
				identityEl.value = dataUrl;
				if(logoPreviewImgEl) {
					logoPreviewImgEl.src = dataUrl;
					logoPreviewImgEl.style.maxHeight = '60px';
					logoPreviewImgEl.style.width = 'auto';
				}
				// Logo als klickbaren Link setzen
				if(logoPreviewLinkEl) {
					logoPreviewLinkEl.href = dataUrl;
					logoPreviewLinkEl.style.display = 'inline-block';
				}
				if(logoPreviewEl) logoPreviewEl.style.display = 'flex';
				if(removeLogoEl) removeLogoEl.style.display = 'inline-block';
			};
			reader.onerror = () => {
				alert('Fehler beim Lesen der Datei.');
			};
			reader.readAsDataURL(file);
		}catch(err){
			alert('Fehler: ' + (err.message || 'Unbekannt'));
		}
	});
}

if(removeLogoEl){
	removeLogoEl.addEventListener('click', ()=>{
		identityEl.value = '';
		const logoPreviewLinkEl = document.getElementById('logoPreviewLink');
		if(logoPreviewEl) logoPreviewEl.style.display = 'none';
		if(logoPreviewLinkEl) logoPreviewLinkEl.style.display = 'none';
		if(removeLogoEl) removeLogoEl.style.display = 'none';
		if(logoUploadEl) logoUploadEl.value = '';
	});
}

/* EU-Logo Button */
const useEULogoBtn = document.getElementById('useEULogo');
const logoPreviewLinkEl = document.getElementById('logoPreviewLink');
const EU_LOGO_URL = './assets/eu-logo.svg';
const EU_LOGO_LINK_URL = './assets/eu-logo.svg'; // Kann geÃ¤ndert werden zu Info-Seite

if(useEULogoBtn){
	useEULogoBtn.addEventListener('click', ()=>{
		identityEl.value = EU_LOGO_URL;
		if(logoPreviewImgEl) {
			logoPreviewImgEl.src = EU_LOGO_URL;
			logoPreviewImgEl.style.maxHeight = '60px';
			logoPreviewImgEl.style.width = 'auto';
		}
		if(logoPreviewLinkEl) {
			logoPreviewLinkEl.href = EU_LOGO_LINK_URL;
			logoPreviewLinkEl.style.display = 'inline-block';
		}
		if(logoPreviewEl) logoPreviewEl.style.display = 'flex';
		if(removeLogoEl) removeLogoEl.style.display = 'inline-block';
	});
}

// Show preview if identity field already has a value
if(identityEl && identityEl.value){
	const logoUrl = identityEl.value;
	if(logoUrl.startsWith('data:image') || logoUrl.startsWith('./assets/') || logoUrl.startsWith('http')){
		if(logoPreviewImgEl) {
			logoPreviewImgEl.src = logoUrl;
			logoPreviewImgEl.style.maxHeight = '60px';
			logoPreviewImgEl.style.width = 'auto';
		}
		if(logoPreviewLinkEl) {
			logoPreviewLinkEl.href = logoUrl;
			logoPreviewLinkEl.style.display = 'inline-block';
		}
		if(logoPreviewEl) logoPreviewEl.style.display = 'flex';
		if(removeLogoEl) removeLogoEl.style.display = 'inline-block';
	}
}

/* Events: reactions and comments via delegation */
postList.addEventListener('click', (e)=>{
	const t = e.target;
	if(t.matches('.reaction')){
		const container = t.closest('.reactions');
		const idx = Number(container?.dataset?.idx);
		const reaction = t.dataset.reaction;
		const db = loadDB();
		const p = db.posts[idx]; if(!p) return;
		p.reactions[reaction] = (p.reactions[reaction]||0) + 1;
		saveDB(db); render();
	}
	if(t.matches('[data-add-comment]')){
		const idx = Number(t.dataset.addComment);
		const input = postList.querySelector(`input[data-comment-input="${idx}"]`);
		const text = (input?.value||'').trim();
		if(!text) return;
		const db = loadDB();
		const p = db.posts[idx]; if(!p) return;
		p.comments.push({text, by: (initialsEl.value||'Anon').trim(), at: Date.now()});
		saveDB(db); render();
	}
	if(t.matches('[data-delete-post]')){
		if(!confirm('Beitrag wirklich lÃ¶schen?')) return;
		const idx = Number(t.dataset.deletePost);
		const db = loadDB();
		db.posts.splice(idx,1);
		saveDB(db); render();
	}
});

/* Reactions palette info (purely visual helper) */
reactionsPalette.addEventListener('click', (e)=>{
	const t = e.target.closest('.chip'); if(!t) return;
	document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
	t.classList.add('active');
});

/* Import/Export JSON */
exportJsonBtn.addEventListener('click', ()=>{
	download('manifest-forum.json', JSON.stringify(loadDB(), null, 2));
});

// VollstÃ¤ndiger Export (Alle Daten)
if(exportCompleteBtn){
	exportCompleteBtn.addEventListener('click', ()=>{
		const exportData = {
			version: '1.0',
			exportedAt: new Date().toISOString(),
			userId: getOrCreateUserId(),
			manifest: loadDB(),
			settings: {
				userPreferences: localStorage.getItem('userPreferences') ? (function() { try { return JSON.parse(localStorage.getItem('userPreferences')); } catch(e) { return {}; } })() : {},
				verified: localStorage.getItem('mot_verified_v1') ? (function() { try { return JSON.parse(localStorage.getItem('mot_verified_v1')); } catch(e) { return null; } })() : null,
				userId: localStorage.getItem('mot_user_id_v1'),
			},
		};
		
		// Backup-Liste hinzufÃ¼gen
		const backups = [];
		try {
			for (let i = 0; i < localStorage.length; i++) {
				const key = localStorage.key(i);
				if (key && key.startsWith('ts_backup_')) {
					try {
						backups.push({
							key,
							timestamp: key.split('_').pop(),
						});
					} catch (e) {}
				}
			}
		} catch (e) {}
		
		exportData.backups = backups;
		
		const jsonData = JSON.stringify(exportData, null, 2);
		const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
		download(`togethersystems-complete-export-${timestamp}.json`, jsonData);
	});
}

importJsonInput.addEventListener('change', async ()=>{
	const f = importJsonInput.files?.[0]; if(!f) return;
	const text = await f.text();
	try{
		const data = (function() { try { return JSON.parse(text); } catch(e) { console.error('JSON parse error:', e); return null; } })();
		if(!data || typeof data !== 'object') throw new Error('UngÃ¼ltiges Format');
		
		// UnterstÃ¼tze sowohl einfaches Format als auch vollstÃ¤ndigen Export
		let postsToImport = [];
		if (data.manifest && Array.isArray(data.manifest.posts)) {
			postsToImport = data.manifest.posts;
			// Importiere auch Settings wenn vorhanden
			if (data.settings) {
				if (data.settings.userPreferences) {
					localStorage.setItem('userPreferences', JSON.stringify(data.settings.userPreferences));
				}
				if (data.settings.userId) {
					localStorage.setItem('mot_user_id_v1', data.settings.userId);
				}
			}
		} else if (Array.isArray(data.posts)) {
			postsToImport = data.posts;
		} else {
			throw new Error('Keine Posts im Export gefunden');
		}
		
		const db = loadDB();
		db.posts = [...postsToImport, ...db.posts]; // Neue Posts am Anfang
		saveDB(db);
		render();
		alert(`âœ… Import erfolgreich! ${postsToImport.length} Posts importiert.`);
	}catch(err){ alert('Import fehlgeschlagen: '+err.message); }
	importJsonInput.value = '';
});

/* Export static site */
exportSiteBtn.addEventListener('click', ()=>{
	const db = loadDB();
	const html = renderStaticSite(db);
	download('manifest-site.html', html);
});
// Offline-Kopie dieser Datei speichern (fÃ¼r Weitergabe/Archiv)
if(downloadSelfBtn){
	downloadSelfBtn.addEventListener('click', ()=>{
		try{
			const html = document.documentElement.outerHTML;
			download('manifest-forum-offline.html', html);
		}catch(err){
			alert('Offline-Kopie konnte nicht erstellt werden: '+(err?.message||String(err)));
		}
	});
}
function renderStaticSite(db){
	const items = db.posts.map(p=>{
		const logoUrl = p.logoUrl || p.identity;
		const logoHtml = logoUrl && (logoUrl.startsWith('data:image') || logoUrl.startsWith('./assets/') || logoUrl.startsWith('http'))
			? `<a href="${escapeHtml(logoUrl)}" target="_blank" rel="noopener noreferrer" style="display:inline-block;line-height:0;flex-shrink:0;"><img src="${escapeHtml(logoUrl)}" alt="Logo" style="width:48px;height:48px;border-radius:8px;object-fit:cover;border:1px solid #e5e7eb;cursor:pointer;"></a>`
			: '';
		return `
		<article style="background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:16px">
			<div style="display:flex;align-items:flex-start;gap:12px;margin-bottom:8px">
				${logoHtml}
				<div style="flex:1">
					<h3 style="margin:0 0 6px;font:600 18px system-ui">${escapeHtml(p.title||'Ohne Titel')}</h3>
					<div style="color:#6b7280;font:12px system-ui">${new Date(p.createdAt).toLocaleString()} ${p.initials? 'Â· '+escapeHtml(p.initials):''} ${p.tags?.length? 'Â· Tags: '+p.tags.map(escapeHtml).join(', '):''}</div>
				</div>
			</div>
			<div style="margin-top:8px;white-space:pre-wrap">${escapeHtml(p.content)}</div>
			<div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
				${REACTIONS.map(r=>{
					const count = p.reactions?.[r.key]||0;
					return count? `<span style="border:1px solid #e5e7eb;border-radius:999px;padding:4px 8px;font:12px system-ui">${r.label} (${count})</span>`:'';
				}).join('')}
			</div>
			${p.comments?.length? `<div style="margin-top:10px">${p.comments.map(c=>`<div style="border:1px solid #e5e7eb;background:#fafafa;border-radius:10px;padding:8px 10px;margin-top:6px"><strong>${escapeHtml(c.by||'Anon')}</strong>: ${escapeHtml(c.text)} <span style="color:#6b7280;font:12px system-ui;margin-left:6px">${new Date(c.at).toLocaleString()}</span></div>`).join('')}</div>`:''}
		</article>
	`;}).join('\n');
	return `<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Manifest of Thinkers â€“ BeitrÃ¤ge</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<style>
	body{margin:0;background:#f4f2ee;color:#1f1f1f;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Ubuntu,Oxygen,Cantarell,"Helvetica Neue",Arial,sans-serif}
	.w{max-width:960px;margin:0 auto;padding:16px}
	.h{position:sticky;top:0;z-index:1;backdrop-filter:saturate(1.2) blur(6px);background:#f4f2eecc;border-bottom:1px solid #e5e7eb}
	.h>.w{display:flex;align-items:center;gap:12px;padding:10px 16px}
	.badge{width:36px;height:36px;border-radius:50%;display:grid;place-items:center;color:#fff;background:#0a66c2;font-weight:700}
	h1{font-size:18px;margin:0}
	.grid{display:grid;gap:16px;margin-top:16px}
</style>
<div class="h"><div class="w"><div class="badge">MoT</div><h1>Manifest of Thinkers â€“ BeitrÃ¤ge</h1></div></div>
<div class="w">
	<div class="grid">
		${items || '<div style="color:#6b7280">Keine EintrÃ¤ge vorhanden.</div>'}
	</div>
	<footer style="color:#6b7280;font:12px system-ui;margin:24px 0;text-align:center">Aus Offline-App exportiert Â· Manifest of Thinkers</footer>
</div>`;
}

/* Publish to API (manual trigger only) */
testPayloadBtn.addEventListener('click', ()=>{
	const payload = buildPayload();
	publishStatus.textContent = JSON.stringify(payload, null, 2);
});
publishBtn.addEventListener('click', async ()=>{
	const url = apiUrlEl.value.trim();
	if(!url){ alert('Bitte API-Endpoint angeben.'); return; }
	const key = apiKeyEl.value.trim();
	const payload = buildPayload();
	publishStatus.textContent = 'Sende ...';
	try {
		  const res = await fetch(url, {
		} catch (err) {
		  console.error('API error:', err);
		  return null;
		}
			method:'POST',
			headers: {
				'Content-Type':'application/json',
				...(key? {'Authorization': key}: {})
			},
			body: JSON.stringify(payload)
		});
		const text = await res.text();
		publishStatus.textContent = 'Status: '+res.status+' '+res.statusText+'\n\n'+text;
	}catch(err){
		publishStatus.textContent = 'Fehler: '+err.message;
	}
});
function buildPayload(){
	const db = loadDB();
	return {
		source: 'manifest-of-thinkers-offline',
		version: 1,
		sentAt: new Date().toISOString(),
		posts: db.posts
	};
}

/* Nachrichten-System (Offline-First) */
function loadMessagesDB(){
	try{
		const raw = localStorage.getItem('messages.db');
		return raw ? (function() { try { return JSON.parse(raw); } catch(e) { console.error('JSON parse error:', e); return null; } })() : { inbox: [], outbox: [] };
	}catch{
		return { inbox: [], outbox: [] };
	}
}
function saveMessagesDB(db){
	try{
		localStorage.setItem('messages.db', JSON.stringify(db));
	}catch(err){
		console.error('Failed to save messages DB:', err);
	}
}
// Beim Portal-Ã–ffnen: Nachrichten synchronisieren
async function syncMessagesOnPortalOpen(){
	const uid = getOrCreateUserId();
	const db = loadMessagesDB();
	
	// Outbox â†’ Server (wird im Portal gemacht)
	// Inbox â† Server (wird im Portal gemacht)
	
	// Signal an das Portal, dass es synchronisieren soll
	localStorage.setItem('messages.sync_requested', 'true');
	localStorage.setItem('messages.sync_user_id', uid);
}

/* Init */
/* Portal Ã¶ffnen mit Token (ohne HMAC, offline-/Single-File-freundlich).
   - Wenn Datei online unter ts-portal/pages.dev lÃ¤uft â†’ relative URL.
   - Wenn Datei lokal (file://) geÃ¶ffnet wird â†’ feste Online-URL verwenden. */
document.addEventListener('click', async (e)=>{
	const t = e.target;
	if(t && t.id === 'openPortalBtn'){
		const uid = getOrCreateUserId();
		const ts = String(motNow());
		let baseUrl = './manifest-portal.html';
		if(location.protocol === 'file:'){
			// Lokale Kopie â†’ direkt die Online-Portal-URL Ã¶ffnen
			baseUrl = 'https://ts-portal.pages.dev/manifest-portal.html';
		}
		const url = `${baseUrl}#mot=${encodeURIComponent(MOT_ACCESS_TOKEN)}&uid=${encodeURIComponent(uid)}&ts=${encodeURIComponent(ts)}`;
		
		// Nachrichten-Sync vorbereiten
		await syncMessagesOnPortalOpen();
		
		window.open(url, '_blank');
	}
});
// Einfache Mesh-/P2P-Demo-Events (lokal, ohne echtes Netzwerk)
const meshStatusEl = document.getElementById('meshStatus');
const meshPeersBtnEl = document.getElementById('meshPeersBtn');
const meshSyncBtnEl = document.getElementById('meshSyncBtn');
if(meshPeersBtnEl && meshStatusEl){
	meshPeersBtnEl.addEventListener('click', ()=>{
		meshStatusEl.textContent = 'Suche nach Peers im lokalen Netz (Demo-Status, Backend optional).';
	});
}
if(meshSyncBtnEl && meshStatusEl){
	meshSyncBtnEl.addEventListener('click', ()=>{
		meshStatusEl.textContent = 'P2P-Sync vorbereitet â€“ sobald ein echter Sync-Dienst vorhanden ist, werden BeitrÃ¤ge Ã¼bertragen.';
	});
}
trySeedComposer();
render();

/* AI-Assistent Integration */
const aiAssistBtn = document.getElementById('aiAssistBtn');
if(aiAssistBtn && typeof AIManifestAssistant !== 'undefined'){
	aiAssistBtn.addEventListener('click', async ()=>{
		const content = contentEl.value.trim();
		if(!content || content.length < 20){
			alert('Bitte gib mindestens 20 Zeichen Inhalt ein, damit die KI-Assistenz hilfreiche VorschlÃ¤ge machen kann.');
			return;
		}
		
		aiAssistBtn.disabled = true;
		aiAssistBtn.textContent = 'ğŸ¤– Analysiere...';
		
		try{
			const result = await AIManifestAssistant.suggestTitleAndSummary(content);
			if(result){
				// Titel vorschlagen
				if(!titleEl.value.trim() && result.title){
					titleEl.value = result.title;
				}
				// Tags vorschlagen
				const existingTags = parseTags(tagsEl.value || '');
				const newTags = result.tags.filter(t => !existingTags.includes(t));
				if(newTags.length > 0){
					const currentTags = tagsEl.value ? tagsEl.value + ', ' : '';
					tagsEl.value = currentTags + newTags.join(', ');
				}
				alert('âœ… KI-VorschlÃ¤ge eingefÃ¼gt!\n\nTitel: ' + (result.title || '(unverÃ¤ndert)') + '\nTags: ' + newTags.join(', ') + '\n\nZusammenfassung: ' + result.summary);
			}else{
				alert('âš ï¸ KI-Assistenz konnte keine VorschlÃ¤ge generieren. Bitte versuche es spÃ¤ter erneut.');
			}
		}catch(err){
			alert('Fehler bei KI-Assistenz: ' + (err?.message || String(err)));
		}finally{
			aiAssistBtn.disabled = false;
			aiAssistBtn.textContent = 'ğŸ¤– KI-Assistenz';
		}
	});
}
</script>
<script src="./ai-frontend-integration.js"></script>
<script type="module" src="./autofix-client.js"></script>
<script src="./rich-media-posts.js"></script>
<script src="./data-export-enhanced.js"></script>
<script src="./offline-queue-manager.js"></script>
<script src="./e2e-encryption-manager.js"></script>
</body>
</html>