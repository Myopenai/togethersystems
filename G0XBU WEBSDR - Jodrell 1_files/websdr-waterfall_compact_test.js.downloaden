//WebSDR HTML5 client side - Copyright 2013-2015, pa3fwm@websdr.org - all rights reserved
//Since the intended use of this code involves sending a copy to the client computer, I (PA3FWM) hereby allow making it available unmodified, via my original WebSDR server software, to original WebSDR clients. Other use, including distribution in part or entirety or as part of other software, or reverse engineering, is not allowed without my explicit prior permission.
(function(){var s=!0,u=!1,v=0,y=0,B=1;if(!window.requestAnimationFrame)for(var I;;){if(I=window.mozRequestAnimationFrame){window.requestAnimationFrame=I;break}if(I=window.webkitRequestAnimationFrame){window.requestAnimationFrame=I;break}B=0;break}
function V(){function J(c){var a=c.layerX||c.offsetX,b=c.wheelDelta||-c.detail;0<b?L(-2,a):0>b&&L(-1,a);return cancelEvent(c)}var b=waterfallapplet[i];function N(c){var h=a.width<<a.maxzoom-a.b;c=dragorigval-(c-dragorigX<<a.maxzoom-a.b);a.strictbandlimits?(0>c&&(c=0),h=(1024<<a.maxzoom)-(1024<<a.maxzoom-a.b)):(c<-h/2&&(c=-h/2),h=(1024<<a.maxzoom)-h/2);c>h&&(c=h);B?(a.z=c,b.q=1):(h=a.c,a.c=c,a.d("GET /~~waterparam?start="+c),A(h,a.c,a.b,u),K())}function W(c){var a=getMouseXY(c);N(a.x);return cancelEvent(c)}
function O(c){c.preventDefault();a.l=s;a.j=10}function P(c){c.preventDefault();setTimeout(X,300)}function X(){a.l=u}function Q(c){c.preventDefault();var b=0;c=Math.floor(10*c.scale);c>a.j+1&&(b=-1);c<a.j-1&&(b=1);0!=b&&(x(b,(a.p+a.w)/2),a.j=c)}function R(c){c.preventDefault();1==c.targetTouches.length&&(a.C=dragorigX,dragorigX=c.targetTouches[0].pageX,a.l==u&&(dragging=s,dragorigval=a.c,a.t=a.i,a.i=(new Date).getTime(),clearTimeout(a.B)))}function S(c){c.preventDefault();for(var b=0;b<c.touches.length;b++){var d=
c.touches[b];a.w=a.p;a.p=d.pageX;a.l==u&&(N(d.pageX),a.t=0,a.i=0)}}function Y(){x(1,dragorigX)}function T(c){c.preventDefault();dragging=u;(c=a.i-a.t)&&300>c?x(-1,dragorigX):a.i&&300>(new Date).getTime()-a.i&&(a.B=setTimeout(Y,300))}function U(){if(b.q){b.q=0;var c=a.c;a.c=a.z;a.d("GET /~~waterparam?start="+a.z);A(c,a.c,a.b,u);K()}b.r&&(c=d.o,b.r=0,d.a.drawImage(d,0,1,d.width,d.height-1,0,0,d.width,d.height-1),d.a.putImageData(c,0,d.height-1),(a.h!=a.b||a.g!=a.c)&&A(a.g,a.c,a.h,s));requestAnimationFrame(U)}
function K(){zoomchange(a.v,a.b,a.c)}function A(c,h,n,e){var f=b.width,g=0,k=d.height-g;if(e)if(y){if(g=q-1,k=1,0>g)return}else g=d.height-1,k=1;if(n==a.b)try{if(h<c){var l=c-h>>a.maxzoom-a.b;d.a.drawImage(d,0,g,f-l,k,l,g,f-l,k);d.a.fillStyle="#000000";d.a.fillRect(0,g,l,k);e||(j.a.drawImage(j,0,g,f-l,k,l,g,f-l,k),j.a.fillStyle="#000000",j.a.fillRect(0,g,l,k))}else if(h>c){var m=h-c>>a.maxzoom-a.b;d.a.drawImage(d,m,g,f-m,k,0,g,f-m,k);d.a.fillStyle="#000000";d.a.fillRect(f-m,g,m,k);e||(j.a.drawImage(j,
m,g,f-m,k,0,g,f-m,k),j.a.fillStyle="#000000",j.a.fillRect(f-m,g,m,k))}}catch(w){}else if(a.m=s,n>a.b)m=1<<n-a.b,l=0.5+1024*(-h+c)/(1024<<a.maxzoom-a.b),d.a.drawImage(d,0,g,f,k,l,g,f/m,k),d.a.fillStyle="#000000",d.a.fillRect(0,g,l,k),d.a.fillRect(l+f/m,g,f,k),!e&&y&&(j.a.drawImage(j,0,g,1024,k,l,g,1024/m,k),j.a.fillStyle="#000000",j.a.fillRect(0,g,l,k),j.a.fillRect(l+f/m,g,f,k));else{m=1<<a.b-n;l=0.5+(h-c>>a.maxzoom-n);try{d.a.drawImage(d,l,g,f/m,k,0,g,f,k),!e&&y&&j.a.drawImage(j,l,g,f/m,k,0,g,f,k)}catch(r){d.a.fillStyle=
"#000000",d.a.fillRect(0,g,f,k),!e&&y&&j.a.fillRect(0,g,f,k)}}}function x(c,b){if(0!=a.maxzoom){var d=a.b,e=a.c,f=a.c+(b<<a.maxzoom-a.b);a.b-=c;0>a.b&&(a.b=0);a.b>a.maxzoom&&(a.b=a.maxzoom);var g=a.width<<a.maxzoom-a.b,f=f-(b<<a.maxzoom-a.b);a.strictbandlimits?(0>f&&(f=0),g=(1024<<a.maxzoom)-g):(f<-g/2&&(f=-g/2),g=(1024<<a.maxzoom)-g/2);f>g&&(f=g);a.c=f;A(e,a.c,d,u);a.d("GET /~~waterparam?zoom="+a.b+"&start="+a.c);K()}}function L(c,d){if(-1==c)x(1,d);else if(-2==c)x(-1,d);else{var e=this.b,j=this.c,
f=c,g=b.width;0>f&&(f=0);f>this.maxzoom&&(f=this.maxzoom);this.strictbandlimits&&(0>d&&(d=0),g=(1024<<this.maxzoom)-(g<<this.maxzoom-f),d>g&&(d=g));this.d("GET /~~waterparam?zoom="+f+"&start="+d);this.b=f;this.c=d;A(j,a.c,e,u);K()}}b.width||(b.width=1024);b.height&&(b.height=b.height);b.height||(b.height=window.D||200);document.getElementById(b.div).innerHTML='<div id="wfcdiv'+v+'" style="height:'+b.height+'px;overflow:hidden;position:relative;filter:sepia(.4)invert(.03)brightness(105%)contrast(105%)grayscale(.1)hue-rotate(0deg)url(#svgGradientMap)"><canvas class="html5waterfall" id="wf1canvas'+v+'" width="'+
b.width+'" height="'+b.height+'" style="position:absolute">test</canvas><canvas class="html5waterfall" id="wf2canvas'+v+'" width="'+b.width+'" height="'+b.height+'" style="position:absolute">test</canvas><svg><filter id="svgGradientMap"><fecolormatrix type="saturate" values="0" /><feComponentTransfer color-interpolation-filters="sRGB"><feFuncR type="table" tableValues="0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.06,0.11,0.17,0.22,0.28,0.33,0.39,0.44,0.5,0.56,0.61,0.67,0.72,0.78,0.83,0.89,0.94,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0.99,0.99,0.98,0.98,0.97,0.97,0.96,0.96,0.96"/><feFuncG type="table" tableValues="0,0.01,0.02,0.04,0.05,0.06,0.07,0.08,0.09,0.11,0.12,0.13,0.14,0.15,0.16,0.18,0.19,0.2,0.21,0.22,0.24,0.25,0.26,0.27,0.28,0.32,0.35,0.39,0.42,0.46,0.49,0.53,0.56,0.6,0.64,0.67,0.71,0.74,0.78,0.81,0.85,0.88,0.92,0.9,0.88,0.86,0.84,0.82,0.8,0.78,0.76,0.75,0.73,0.71,0.69,0.67,0.65,0.63,0.61,0.59,0.57,0.55,0.54,0.52,0.5,0.48,0.46,0.44,0.42,0.4,0.38,0.36,0.34,0.32,0.31,0.29,0.27,0.25,0.23,0.21,0.19,0.17,0.15,0.13,0.11,0.1,0.08,0.06,0.04,0.02,0,0.14,0.27,0.41,0.55,0.69,0.82,0.96,0.96,0.96"/><feFuncB type="table" tableValues="0,0.04,0.08,0.13,0.17,0.21,0.25,0.29,0.33,0.38,0.42,0.46,0.5,0.54,0.58,0.63,0.67,0.71,0.75,0.79,0.83,0.88,0.92,0.96,1,0.94,0.89,0.83,0.78,0.72,0.67,0.61,0.56,0.5,0.44,0.39,0.33,0.28,0.22,0.17,0.11,0.06,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.14,0.27,0.41,0.55,0.69,0.82,0.96,0.96,0.96"/></feComponentTransfer></filter></svg></div>';b.f=document.getElementById("wfcdiv"+v);var t=0<=v?"on":"off";b.f.v=b.id;b.f.band=b.band;b.f.width=b.width;b.f.height=b.height;b.f.maxzoom=b.maxzoom;b.f.strictbandlimits=b.strictbandlimits;b=b.f;b.r=0;b.q=0;b.destroy=function(){try{b.e.close()}catch(c){}b.parentNode.removeChild(b)};var C=
document.getElementById("wf1canvas"+v),E=document.getElementById("wf2canvas"+v),d=C,j=E;y||(j.height=0);v++;C.a=C.getContext("2d");E.a=E.getContext("2d");d.a.fillStyle="#000000";d.a.fillRect(0,0,d.width,d.height);C.o=C.a.createImageData(1024,1);E.o=E.a.createImageData(1024,1);var a=b;-1<v&&(t+="mes");b.mode=1;var F=new Uint8Array(256),G=new Uint8Array(256),H=new Uint8Array(256),e;for(e=0;64>e;e++)F[e]=0,G[e]=0,H[e]=2*e;for(;128>e;e++)F[e]=3*e-192,G[e]=0,H[e]=2*e;for(;192>e;e++)F[e]=e+64,G[e]=256*
Math.sqrt((e-128)/64),H[e]=511-2*e;for(;256>e;e++)F[e]=255,G[e]=255,H[e]=512+2*e;b.b=0;b.c=0;-2<v&&(t+="sa");b.h=0;b.g=0;b.k=b.width;b.m=s;b.s=[];b.l=u;b.j=10;b.p=0;b.w=0;b.t=0;b.i=0;b.B=0;-3<v&&(t+="ge");var w=new Uint8Array(1024);for(e=0;e<a.k;e++)w[e]=8;var q=0,M=0;onmessage=function(c){c=new Uint8Array(c.data);if(255==c[0]){if(255!=c[1]){var h=c;c=w;1==h[1]&&(a.g=h[3]+(h[4]<<8)+(h[5]<<16)+(h[6]<<24),128>h[2]&&(a.h=h[2]),h=h.subarray(8));if(2==h[1]){a.k=h[2]+(h[3]<<8);for(h=0;h<a.k;h++)c[h]=8}return}c=
c.subarray(1)}for(h=0;1>h;h++){if(1==a.n){var n=c,p=w;for(e=0;e<n.length;e++)z=16*(n[e]&15)+2,p[2*e]=z,z=n[e]&242,p[2*e+1]=z}if(9==a.n)for(var n=c,p=w,f=0,g=0,k=0,l=0,m=0,t=0;k<b.k;){var l=n[g]<<8+f|n[g+1]<<f,r=0,x=1;l&32768&&(l=128*m+((l&32512)>>8),r=Z[l],x=$[l]);f+=x;8<=f&&(f-=8,g++);if(1==r||-1==r)m=1;if(1<r||-1>r)m=2;0==r&&(m=0);t+=r<<4;r=p[k]+t;0>r&&(r=8);255<r&&(r=248);p[k]=r;k++}}h=d.o;if(0!=a.mode){for(c=0;1024>c;c++)n=w[c],h.data[4*c]=F[n],h.data[4*c+1]=G[n],h.data[4*c+2]=H[n],h.data[4*c+
3]=255;M++;300==M&&(M=0);y?(d.a.putImageData(h,0,q),d.style.top=d.height-q+"px",j.style.top=-q+"px",q++,q>=d.height&&(q=0,c=j,j=d,d=c)):B?b.r=1:(d.a.drawImage(d,0,1,d.width,d.height-1,0,0,d.width,d.height-1),d.a.putImageData(h,0,d.height-1));!B&&(a.h!=a.b||a.g!=a.c)&&A(a.g,a.c,a.h,s)}else{d.a.fillStyle="#000000";d.a.fillRect(0,0,d.width,d.height);d.a.fillStyle="#00ffff";if(a.m){for(c=0;1024>c;c++)a.s[c]=w[c];a.m=u}for(c=0;c<b.width;c++)n=0.5*(w[c]+a.s[c]),a.s[c]=n,n*=d.height/255,d.a.fillRect(c,d.height-
n,1,n)}};d.addEventListener("mousewheel",J);d.addEventListener("DOMMouseScroll",J);j.addEventListener("mousewheel",J);j.addEventListener("DOMMouseScroll",J);b.onmousedown=function(c){var a=getMouseXY(c);dragging=s;document.onmousemove=W;dragorigX=a.x;dragorigval=this.c;return cancelEvent(c)};B&&requestAnimationFrame(U);window.isTouchDev&&(d.addEventListener("gesturestart",O),d.addEventListener("gesturechange",Q),d.addEventListener("gestureend",P),j.addEventListener("gesturestart",O),j.addEventListener("gesturechange",
Q),j.addEventListener("gestureend",P),d.addEventListener("touchstart",R),d.addEventListener("touchmove",S),d.addEventListener("touchend",T),j.addEventListener("touchstart",R),j.addEventListener("touchmove",S),j.addEventListener("touchend",T));b.setSize=function(c,a){var e=document.createElement("canvas"),p=Math.min(d.height,a),f=Math.min(d.width,c);e.width=f;e.height=p;y?(e.height=p,0<q&&e.getContext("2d").drawImage(d,0,0,f,q,0,p-q,f,q),0<p-q&&e.getContext("2d").drawImage(j,0,j.height-(p-q),f,p-q,
0,0,f,p-q),d.height=a,d.width=c,j.height=a,j.width=c,this.style.height=a+"px",j.a.drawImage(e,0,a-e.height),q=0):(e.height=p,e.getContext("2d").drawImage(d,0,d.height-p,f,p,0,0,f,p),d.height=a,d.width=c,d.a.drawImage(e,0,a-e.height));this.style.height=a+"px";this.style.width=c+"px";b.width=c;this.d("GET /~~waterparam?width="+c)};b.setheight=function(){};b.setzoom=L;b.A=4;b.setslow=function(a){b.A=a;this.d("GET /~~waterparam?slow="+a)};b.setmode=function(a){if((2<=this.mode||2<=a)&&this.mode!=a){var b=
a;0==b&&(b=1);this.d("GET /~~waterparam?scale="+b)}0==a&&0!=this.mode&&(q=d.height-1,j.style.top=d.height+"px",d.style.top="0px",smoothbinvalid=s);this.mode=a};b.setdmin=function(a){this.d("GET /~~waterparam?dmin="+a)};b.setdmax=function(a){this.d("GET /~~waterparam?dmax="+a)};b.setdminmax=function(a,b){this.d("GET /~~waterparam?dmin="+a+"&dmax="+b)};b.setband=function(a,b,d,e){this.h=this.b=d;this.g=this.c=e;this.maxzoom=b;this.d("GET /~~waterparam?band="+a+"&zoom="+this.b+"&start="+this.c)};var aa=
b.width;b.n=9;b.e=null;b.u=1;b.startstop=function(a){if(a&&!b.e)b.e=new WebSocket("ws://"+window.location.host+"/~~waterstream"+b.band+"?format="+b.n+"&width="+aa+"&zoom="+this.b+"&start="+this.c),b.e.binaryType="arraybuffer",b.e[t]=onmessage,b.m=s,w=new Uint8Array(1024),b.e.onopen=!b.u?function(){b.d("GET /~~waterparam?zoom="+b.b+"&start="+b.c+"&slow="+b.A)}:function(){waterfallappletstarted(this.v)},b.u=0;else if(!a&&b.e){try{b.e.close()}catch(d){}b.e=null}};b.d=function(a){this.e&&this.e.send(a)};
b.startstop(1);var Z=[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,5,5,7,7,9,11,13,15,-5,-5,-7,-7,-9,-11,-13,-15,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,
-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,-5,7,7,9,9,11,11,13,15,-7,-7,-9,-9,-11,-11,-13,-15],$=[3,3,3,3,3,3,3,3,3,
3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,7,7,7,7,8,8,8,8,7,7,7,7,8,8,8,8,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,3,3,
3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,7,7,7,7,7,7,8,8,7,7,7,7,7,7,8,8];return b}window.prep_html5waterfalls = function() {
    for (i = 0; i < nwaterfalls; i++) waterfallapplet[i] = V();
};
window.Waterfall = V;  // âœ… Make the Waterfall constructor globally available

prep_html5waterfalls();
})();

